# ‚úÖ –°–∏—Å—Ç–µ–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ú–∏–≥—Ä–∞—Ü–∏—è —Å Supabase –Ω–∞ Prisma/JWT

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

‚úÖ **–£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏:**
- `app/(dashboard)/profiles/[slug]/edit/client.tsx` - —É–¥–∞–ª–µ–Ω—ã –ª–∏—à–Ω–∏–µ `</div>`, `)`, `}`
- `app/(dashboard)/layout.tsx` - —É–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è `</TooltipProvider>`
- `components/shared/database-indicator.tsx` - —É–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Ä—Ñ–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞:**
- `app/api/subscriptions/check-feature/route.ts` - —É–¥–∞–ª–µ–Ω –æ—Ä—Ñ–∞–Ω–Ω—ã–π `{ status: 401 }`
- `lib/auth/jwt.ts` - —É–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è —Ñ—É–Ω–∫—Ü–∏—è `verifyJWT`

### 2. –°–æ–∑–¥–∞–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Supabase

‚úÖ **–°–æ–∑–¥–∞–Ω—ã stub-—Ñ–∞–π–ª—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:**
- `lib/supabase/server.ts` - server-side –∫–ª–∏–µ–Ω—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- `lib/supabase/client.ts` - client-side –∫–ª–∏–µ–Ω—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏. –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JWT –∏ Prisma.

### 3. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ JWT

‚úÖ **–°–æ–∑–¥–∞–Ω—ã API endpoints –¥–ª—è JWT Auth:**
- `app/api/auth/login/route.ts` - –≤—Ö–æ–¥ —Å email/password
- `app/api/auth/register/route.ts` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `app/api/auth/signout/route.ts` - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

‚úÖ **–°–æ–∑–¥–∞–Ω—ã —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT:**
- `lib/auth/get-current-user.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- `lib/contexts/auth-context-jwt.tsx` - AuthContext –¥–ª—è JWT (—á–∏—Ç–∞–µ—Ç cookies)

‚úÖ **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
- `app/(auth)/login/page.tsx` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/api/auth/login`
- `app/(auth)/register/page.tsx` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/api/auth/register`
- –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π `app/auth/signout/route.ts` (Supabase)

### 4. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã 8 —Ñ–∞–π–ª–æ–≤:**
- `app/(dashboard)/profiles/[slug]/edit/page.tsx`
- `app/(public)/profiles/[slug]/page.tsx`
- `app/(dashboard)/my-requests/[id]/edit/page.tsx`
- `app/(dashboard)/my-requests/[id]/page.tsx`
- `app/claim/token/[token]/page.tsx`
- `app/claim/[slug]/page.tsx`
- `app/debug-auth/page.tsx`
- `app/quick-profile/page.tsx`

‚úÖ **–í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–ª–µ–Ω—ã test-—Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
- `app/test-auth/page.tsx` - —Ç–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç JWT Auth —á–µ—Ä–µ–∑ `useAuth()`
- `app/quick-login/page.tsx` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/api/auth/login`

### 5. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

‚úÖ **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω bcryptjs –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π:**
```bash
npm install bcryptjs @types/bcryptjs --legacy-peer-deps
```

## üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã

1. **scripts/find-duplicate-closings.mjs** - –ø–æ–∏—Å–∫ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤
2. **scripts/find-supabase-auth-usage.mjs** - –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö Supabase Auth
3. **scripts/migrate-all-files.mjs** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Å Supabase –Ω–∞ JWT
4. **scripts/check-ads-data.mjs** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π

## üîê –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### Server-Side (–≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –∏ API routes):
```typescript
import { getCurrentUser } from '@/lib/auth/get-current-user'

const user = await getCurrentUser()
if (!user) redirect('/login')
```

### Client-Side (–≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö):
```typescript
import { useAuth } from '@/lib/contexts/auth-context'

const { user, loading } = useAuth()
```

### API Routes (–¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints):
```typescript
import { requireAuth } from '@/lib/auth/get-current-user'

const user = await requireAuth() // Throws if not authenticated
```

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   npm run dev
   ```

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
   - ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ email/password
   - ‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å OAuth
   - ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
   - ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π
   - ‚úÖ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
   - –û—Ç–∫—Ä—ã—Ç—å `/monitoring` (–¥–ª—è –∞–¥–º–∏–Ω–∞)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/api/health`
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `npm run check-system`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Supabase Auth –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—Ö–æ–¥ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ JWT.

2. **–°—Ç–∞—Ä—ã–π callback** (`app/auth/callback/route.ts`) –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

3. **–í—Å–µ cookies —Ç–µ–ø–µ—Ä—å JWT-based:**
   - `auth-token` - HttpOnly cookie —Å JWT —Ç–æ–∫–µ–Ω–æ–º
   - `user-info` - –¥–æ—Å—Ç—É–ø–Ω–∞—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ cookie —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

4. **–ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ bcryptjs** (10 rounds).

5. **Yandex OAuth –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** –∏ –≤—ã–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã.

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ 7 —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫**
- ‚úÖ **–°–æ–∑–¥–∞–Ω—ã 3 –Ω–æ–≤—ã—Ö API endpoint**
- ‚úÖ **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ 10 —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ JWT Auth**
- ‚úÖ **–°–æ–∑–¥–∞–Ω—ã 4 —É—Ç–∏–ª–∏—Ç—ã –∏ —Å–∫—Ä–∏–ø—Ç–∞**
- ‚úÖ **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 2 –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å Supabase –Ω–∞ Prisma + JWT. –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è, —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:**
```bash
npm run dev
```

–ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:4000` –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.

