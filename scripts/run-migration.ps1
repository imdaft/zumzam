# ================================================================================
# ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ STORAGE
# ================================================================================
# Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²ÑĞµ ÑˆĞ°Ğ³Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Storage
# ================================================================================

Write-Host "ğŸš€ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ STORAGE ZUMZAM" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ psql
Write-Host "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ PostgreSQL..." -ForegroundColor Yellow
$psqlPath = Get-Command psql -ErrorAction SilentlyContinue
if (-not $psqlPath) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: psql Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!" -ForegroundColor Red
    Write-Host "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ PostgreSQL Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞµĞ³Ğ¾ Ğ² PATH" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… PostgreSQL Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: $($psqlPath.Source)" -ForegroundColor Green
Write-Host ""

# ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
$DB_HOST = "127.0.0.1"
$DB_PORT = "54322"
$DB_USER = "postgres"
$DB_NAME = "postgres"

Write-Host "ğŸ“‹ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ:" -ForegroundColor Yellow
Write-Host "   Host: $DB_HOST" -ForegroundColor Gray
Write-Host "   Port: $DB_PORT" -ForegroundColor Gray
Write-Host "   User: $DB_USER" -ForegroundColor Gray
Write-Host "   Database: $DB_NAME" -ForegroundColor Gray
Write-Host ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”
Write-Host "ğŸ”Œ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..." -ForegroundColor Yellow
$testConnection = & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "SELECT 1;" 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!" -ForegroundColor Red
    Write-Host "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Supabase Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½: supabase start" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾" -ForegroundColor Green
Write-Host ""

# Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
Write-Host "ğŸ“Š Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Storage" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/check-storage-migration.sql"
Write-Host ""

# Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
Write-Host "â“ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets? (Y/N)" -ForegroundColor Yellow
$confirmation = Read-Host
if ($confirmation -ne "Y" -and $confirmation -ne "y") {
    Write-Host "âŒ ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼" -ForegroundColor Red
    exit 0
}
Write-Host ""

# Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets
Write-Host "ğŸª£ Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/create-storage-buckets.sql"
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ buckets!" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… Storage buckets ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹" -ForegroundColor Green
Write-Host ""

# Ğ¨ĞĞ“ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
Write-Host "ğŸ”„ Ğ¨ĞĞ“ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
Write-Host "âš ï¸  Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: Ğ­Ñ‚Ğ¾Ñ‚ ÑˆĞ°Ğ³ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ²ÑĞµ URL Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!" -ForegroundColor Yellow
Write-Host "   Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ URL (Ğ¡Ğ¨Ğ): https://dijcyhkmzohyvngaioiu.supabase.co/..." -ForegroundColor Gray
Write-Host "   ĞĞ¾Ğ²Ñ‹Ğµ URL (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ): http://127.0.0.1:54321/..." -ForegroundColor Gray
Write-Host ""
Write-Host "â“ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL? (Y/N)" -ForegroundColor Yellow
$updateUrls = Read-Host

if ($updateUrls -eq "Y" -or $updateUrls -eq "y") {
    Write-Host ""
    Write-Host "ğŸ’¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ backup Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼..." -ForegroundColor Yellow
    $backupFile = "backup_before_url_migration_$(Get-Date -Format 'yyyyMMdd_HHmmss').sql"
    & pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME > $backupFile
    if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… Backup ÑĞ¾Ğ·Ğ´Ğ°Ğ½: $backupFile" -ForegroundColor Green
    } else {
        Write-Host "âš ï¸  ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ backup, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼..." -ForegroundColor Yellow
    }
    Write-Host ""
    
    Write-Host "ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL..." -ForegroundColor Yellow
    & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/migrate-storage-urls.sql"
    
    Write-Host ""
    Write-Host "âš ï¸  Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°! ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ²Ñ‹ÑˆĞµ." -ForegroundColor Yellow
    Write-Host "â“ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (COMMIT)? (Y/N)" -ForegroundColor Yellow
    $commitChanges = Read-Host
    
    if ($commitChanges -eq "Y" -or $commitChanges -eq "y") {
        & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "COMMIT;"
        Write-Host "âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ (COMMIT)" -ForegroundColor Green
    } else {
        & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "ROLLBACK;"
        Write-Host "â†©ï¸  Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹ (ROLLBACK)" -ForegroundColor Yellow
    }
} else {
    Write-Host "â­ï¸  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾" -ForegroundColor Yellow
}
Write-Host ""

# Ğ¨ĞĞ“ 4: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
Write-Host "âœ… Ğ¨ĞĞ“ 4: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/check-storage-migration.sql"
Write-Host ""

# Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "ğŸ‰ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!" -ForegroundColor Green
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸ“‹ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:" -ForegroundColor Yellow
Write-Host "   1. âœ… Storage buckets ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹" -ForegroundColor Green
Write-Host "   2. âœ… next.config.ts Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½" -ForegroundColor Green
Write-Host "   3. ğŸ”„ ĞŸĞµÑ€ĞµÑĞ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: npm run build" -ForegroundColor Yellow
Write-Host "   4. ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ dev ÑĞµÑ€Ğ²ĞµÑ€: npm run dev" -ForegroundColor Yellow
Write-Host ""
Write-Host "âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ»Ğ¸ URL, Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Storage!" -ForegroundColor Yellow
Write-Host "   Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: node scripts/copy-storage-files.js" -ForegroundColor Gray
Write-Host ""

# ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ STORAGE
# ================================================================================
# Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²ÑĞµ ÑˆĞ°Ğ³Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Storage
# ================================================================================

Write-Host "ğŸš€ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ STORAGE ZUMZAM" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ psql
Write-Host "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ PostgreSQL..." -ForegroundColor Yellow
$psqlPath = Get-Command psql -ErrorAction SilentlyContinue
if (-not $psqlPath) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: psql Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!" -ForegroundColor Red
    Write-Host "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ PostgreSQL Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞµĞ³Ğ¾ Ğ² PATH" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… PostgreSQL Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: $($psqlPath.Source)" -ForegroundColor Green
Write-Host ""

# ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
$DB_HOST = "127.0.0.1"
$DB_PORT = "54322"
$DB_USER = "postgres"
$DB_NAME = "postgres"

Write-Host "ğŸ“‹ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ:" -ForegroundColor Yellow
Write-Host "   Host: $DB_HOST" -ForegroundColor Gray
Write-Host "   Port: $DB_PORT" -ForegroundColor Gray
Write-Host "   User: $DB_USER" -ForegroundColor Gray
Write-Host "   Database: $DB_NAME" -ForegroundColor Gray
Write-Host ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ‘Ğ”
Write-Host "ğŸ”Œ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..." -ForegroundColor Yellow
$testConnection = & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "SELECT 1;" 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!" -ForegroundColor Red
    Write-Host "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Supabase Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½: supabase start" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾" -ForegroundColor Green
Write-Host ""

# Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
Write-Host "ğŸ“Š Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Storage" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/check-storage-migration.sql"
Write-Host ""

# Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
Write-Host "â“ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets? (Y/N)" -ForegroundColor Yellow
$confirmation = Read-Host
if ($confirmation -ne "Y" -and $confirmation -ne "y") {
    Write-Host "âŒ ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼" -ForegroundColor Red
    exit 0
}
Write-Host ""

# Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets
Write-Host "ğŸª£ Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Storage buckets" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/create-storage-buckets.sql"
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ buckets!" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… Storage buckets ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹" -ForegroundColor Green
Write-Host ""

# Ğ¨ĞĞ“ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
Write-Host "ğŸ”„ Ğ¨ĞĞ“ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
Write-Host "âš ï¸  Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: Ğ­Ñ‚Ğ¾Ñ‚ ÑˆĞ°Ğ³ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ²ÑĞµ URL Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!" -ForegroundColor Yellow
Write-Host "   Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ URL (Ğ¡Ğ¨Ğ): https://dijcyhkmzohyvngaioiu.supabase.co/..." -ForegroundColor Gray
Write-Host "   ĞĞ¾Ğ²Ñ‹Ğµ URL (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ): http://127.0.0.1:54321/..." -ForegroundColor Gray
Write-Host ""
Write-Host "â“ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL? (Y/N)" -ForegroundColor Yellow
$updateUrls = Read-Host

if ($updateUrls -eq "Y" -or $updateUrls -eq "y") {
    Write-Host ""
    Write-Host "ğŸ’¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ backup Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼..." -ForegroundColor Yellow
    $backupFile = "backup_before_url_migration_$(Get-Date -Format 'yyyyMMdd_HHmmss').sql"
    & pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME > $backupFile
    if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… Backup ÑĞ¾Ğ·Ğ´Ğ°Ğ½: $backupFile" -ForegroundColor Green
    } else {
        Write-Host "âš ï¸  ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ backup, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼..." -ForegroundColor Yellow
    }
    Write-Host ""
    
    Write-Host "ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL..." -ForegroundColor Yellow
    & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/migrate-storage-urls.sql"
    
    Write-Host ""
    Write-Host "âš ï¸  Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°! ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ²Ñ‹ÑˆĞµ." -ForegroundColor Yellow
    Write-Host "â“ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (COMMIT)? (Y/N)" -ForegroundColor Yellow
    $commitChanges = Read-Host
    
    if ($commitChanges -eq "Y" -or $commitChanges -eq "y") {
        & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "COMMIT;"
        Write-Host "âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ (COMMIT)" -ForegroundColor Green
    } else {
        & psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "ROLLBACK;"
        Write-Host "â†©ï¸  Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹ (ROLLBACK)" -ForegroundColor Yellow
    }
} else {
    Write-Host "â­ï¸  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾" -ForegroundColor Yellow
}
Write-Host ""

# Ğ¨ĞĞ“ 4: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
Write-Host "âœ… Ğ¨ĞĞ“ 4: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Cyan
& psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "scripts/check-storage-migration.sql"
Write-Host ""

# Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "ğŸ‰ ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!" -ForegroundColor Green
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸ“‹ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:" -ForegroundColor Yellow
Write-Host "   1. âœ… Storage buckets ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹" -ForegroundColor Green
Write-Host "   2. âœ… next.config.ts Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½" -ForegroundColor Green
Write-Host "   3. ğŸ”„ ĞŸĞµÑ€ĞµÑĞ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: npm run build" -ForegroundColor Yellow
Write-Host "   4. ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ dev ÑĞµÑ€Ğ²ĞµÑ€: npm run dev" -ForegroundColor Yellow
Write-Host ""
Write-Host "âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ»Ğ¸ URL, Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Storage!" -ForegroundColor Yellow
Write-Host "   Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: node scripts/copy-storage-files.js" -ForegroundColor Gray
Write-Host ""




