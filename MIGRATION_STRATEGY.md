# üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –ú–ò–ì–†–ê–¶–ò–ò LEGACY –ö–û–î–ê

**–î–∞—Ç–∞:** 26 –¥–µ–∫–∞–±—Ä—è 2025

---

## üìä –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ô –°–ò–¢–£–ê–¶–ò–ò

### ‚úÖ –ß—Ç–æ —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL –≤ Yandex Cloud
- **ORM**: Prisma 5.22.0
- **API (—á–∞—Å—Ç–∏—á–Ω–æ)**: 5 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –Ω–∞ Prisma
  - `/api/profiles/public`
  - `/api/reviews`
  - `/api/master-class-programs`
  - `/api/services`
  - `/api/agency-partners`

### ‚ùå –ß—Ç–æ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase

#### 1. **lib/** - 8 —Ñ–∞–π–ª–æ–≤ (–ö–†–ò–¢–ò–ß–ù–û)
```
lib/contexts/auth-context.tsx (363 —Å—Ç—Ä–æ–∫–∏)
lib/contexts/auth-context-new.tsx (131 —Å—Ç—Ä–æ–∫–∞)
lib/hooks/useProfiles.ts (317 —Å—Ç—Ä–æ–∫)
lib/services/ai-service.ts (1702 —Å—Ç—Ä–æ–∫–∏!)
lib/ai/rag.ts (177 —Å—Ç—Ä–æ–∫)
lib/ai/get-model-for-task.ts (212 —Å—Ç—Ä–æ–∫)
lib/ai/cart-utils.ts (238 —Å—Ç—Ä–æ–∫)
lib/utils/profile-catalog.ts (195 —Å—Ç—Ä–æ–∫)
```

**–ß—Ç–æ –¥–µ–ª–∞—é—Ç:**
- Auth –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Supabase Auth
- useProfiles: –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–∑ –ë–î
- ai-service: —Ä–∞–±–æ—Ç–∞ —Å AI settings –∏–∑ –ë–î
- rag: –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Supabase RPC
- cart-utils: —Ä–∞–±–æ—Ç–∞ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
- profile-catalog: –∫–∞—Ç–∞–ª–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π/—É—Å–ª—É–≥

#### 2. **API routes** - ~25 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
```
/api/upload - Storage
/api/auth/* - Auth callbacks
/api/user - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
/api/ai/* - AI —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
/api/cart/* - –∫–æ—Ä–∑–∏–Ω–∞
... –∏ –¥—Ä—É–≥–∏–µ
```

#### 3. **Components** - 170+ —Ñ–∞–π–ª–æ–≤
#### 4. **Pages** - 40+ —Ñ–∞–π–ª–æ–≤

---

## üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –ú–ò–ì–†–ê–¶–ò–ò

### –ü–æ–¥—Ö–æ–¥: **–ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ä–∏—Å–∫–æ–º**

### –≠–¢–ê–ü 1: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Auth –∏ Database (–¢–ï–ö–£–©–ò–ô)

**–¶–µ–ª—å:** –†–∞–∑–¥–µ–ª–∏—Ç—å Supabase Auth (–æ—Å—Ç–∞–≤–∏—Ç—å) –∏ Database (–º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å)

**–†–µ—à–µ–Ω–∏–µ:**
1. ‚úÖ **Auth** ‚Üí –û—Å—Ç–∞–≤–∏—Ç—å Supabase Auth
   - –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! Supabase Auth –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
   - `auth-context.tsx`, `auth-context-new.tsx` - –ù–ï –¢–†–û–ì–ê–¢–¨
   - Auth callbacks - –ù–ï –¢–†–û–ì–ê–¢–¨

2. ‚ùå **Database** ‚Üí –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Prisma
   - –í—Å–µ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î —á–µ—Ä–µ–∑ Supabase ‚Üí Prisma
   - API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã ‚Üí Prisma
   - –•—É–∫–∏/—É—Ç–∏–ª–∏—Ç—ã ‚Üí API endpoints (–Ω–µ —Ç—è–Ω—É—Ç—å –ë–î –≤ –±—Ä–∞—É–∑–µ—Ä)

### –≠–¢–ê–ü 2: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

**–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–∞–∫—à–Ω):**
1. `lib/services/ai-service.ts` - AI —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
2. `lib/hooks/useProfiles.ts` - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
3. `lib/ai/rag.ts` - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
4. API routes –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã, –∑–∞–∫–∞–∑–æ–≤

**–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):**
5. `lib/ai/cart-utils.ts` - –∫–æ—Ä–∑–∏–Ω–∞
6. `lib/utils/profile-catalog.ts` - –∫–∞—Ç–∞–ª–æ–≥–∏
7. –û—Å—Ç–∞–ª—å–Ω—ã–µ API routes

**–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ä–∞–±–æ—Ç–∞–µ—Ç):**
8. Components (–∏—Å–ø–æ–ª—å–∑—É—é—Ç API)
9. Pages (–∏—Å–ø–æ–ª—å–∑—É—é—Ç API)

### –≠–¢–ê–ü 3: –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ lib/

#### 3.1. `lib/services/ai-service.ts` (1702 —Å—Ç—Ä–æ–∫–∏)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```typescript
import { createClient } from '@/lib/supabase/server'

async getActiveSettings() {
  const supabase = await createClient()
  const { data } = await supabase
    .from('ai_settings')
    .select('*')
    .eq('is_active', true)
    .single()
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
import prisma from '@/lib/prisma'

async getActiveSettings() {
  const data = await prisma.ai_settings.findFirst({
    where: { is_active: true }
  })
  return data
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –£ –Ω–∞—Å –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü `ai_settings`, `ai_task_models`, `ai_settings` –≤ Prisma —Å—Ö–µ–º–µ!

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
2. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
3. –û–±–Ω–æ–≤–∏—Ç—å Prisma —Å—Ö–µ–º—É
4. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å ai-service.ts

#### 3.2. `lib/hooks/useProfiles.ts` (317 —Å—Ç—Ä–æ–∫)

**–ü—Ä–æ–±–ª–µ–º–∞:** –•—É–∫ –¥–µ–ª–∞–µ—Ç –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ API endpoint
```typescript
// –ë—ã–ª–æ (–ø–ª–æ—Ö–æ - –ë–î –≤ –±—Ä–∞—É–∑–µ—Ä–µ):
const { data } = await supabase.from('profiles').select('...')

// –°—Ç–∞–ª–æ (—Ö–æ—Ä–æ—à–æ - —á–µ—Ä–µ–∑ API):
const response = await fetch('/api/profiles/public')
const data = await response.json()
```

#### 3.3. `lib/ai/rag.ts` (177 —Å—Ç—Ä–æ–∫)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase RPC –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
```typescript
await supabase.rpc('match_services', {
  query_embedding: [...],
  match_threshold: 0.6,
  match_count: 5
})
```

**–†–µ—à–µ–Ω–∏–µ:** Prisma —Å raw SQL –¥–ª—è pgvector
```typescript
await prisma.$queryRaw`
  SELECT * FROM services
  WHERE embedding <=> ${embedding}::vector < 0.6
  ORDER BY embedding <=> ${embedding}::vector
  LIMIT 5
`
```

#### 3.4. `lib/ai/get-model-for-task.ts`, `lib/ai/cart-utils.ts`, `lib/utils/profile-catalog.ts`

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ Supabase ‚Üí Prisma

---

## üìù –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô (–ü–û–®–ê–ì–û–í–û)

### –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å—Ç—å –≤ –ë–î
npx prisma db pull

# –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã ai_*
grep -r "ai_settings\|ai_task_models" prisma/schema.prisma
```

### –®–ê–ì 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```sql
-- –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è ai_settings, ai_task_models, etc
CREATE TABLE ai_settings (...);
CREATE TABLE ai_task_models (...);
```

### –®–ê–ì 3: –ú–∏–≥—Ä–∞—Ü–∏—è lib/services/ai-service.ts
- –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `createClient()` –Ω–∞ `prisma`
- –ó–∞–º–µ–Ω–∏—Ç—å `.from('table')` –Ω–∞ `prisma.table`
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–ê–ì 4: –ú–∏–≥—Ä–∞—Ü–∏—è lib/hooks/useProfiles.ts
- –°–æ–∑–¥–∞—Ç—å API endpoint `/api/profiles/public` (—É–∂–µ –µ—Å—Ç—å!)
- –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ö—É–∫ –Ω–∞ `fetch('/api/profiles/public')`
- –£–¥–∞–ª–∏—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

### –®–ê–ì 5: –ú–∏–≥—Ä–∞—Ü–∏—è lib/ai/rag.ts
- –ó–∞–º–µ–Ω–∏—Ç—å `.rpc()` –Ω–∞ `prisma.$queryRaw`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pgvector —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

### –®–ê–ì 6: –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ lib/
- `lib/ai/get-model-for-task.ts`
- `lib/ai/cart-utils.ts`
- `lib/utils/profile-catalog.ts`

### –®–ê–ì 7: –ú–∏–≥—Ä–∞—Ü–∏—è API routes
- –°–ø–∏—Å–æ–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏–∑ `grep` —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–ê–ì 8: Cleanup
- –£–¥–∞–ª–∏—Ç—å `lib/supabase/` (–∫—Ä–æ–º–µ `client.ts` –¥–ª—è Auth)
- –£–¥–∞–ª–∏—Ç—å `@supabase/supabase-js` –∏–∑ `package.json` (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `@supabase/ssr` –¥–ª—è Auth)
- –£–¥–∞–ª–∏—Ç—å backup —Ñ–∞–π–ª—ã

### –®–ê–ì 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–∏–Ω—Ç–µ—Ä
- Prod build
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –ü–†–û–ë–õ–ï–ú–´

### 1. **Supabase RLS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Prisma**
**–ü—Ä–æ–±–ª–µ–º–∞:** Row Level Security –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Supabase
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É RLS –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (middleware, API routes)

### 2. **Supabase RPC —Ñ—É–Ω–∫—Ü–∏–∏**
**–ü—Ä–æ–±–ª–µ–º–∞:** `match_services` –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
**–†–µ—à–µ–Ω–∏–µ:** Prisma raw SQL —Å pgvector

### 3. **Supabase Realtime**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ (`.on('INSERT', ...)`)
**–†–µ—à–µ–Ω–∏–µ:** WebSockets –∏–ª–∏ polling (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ realtime)

### 4. **Storage**
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª—ã –ø–æ–∫–∞ –Ω–∞ Supabase Storage
**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å –ø–æ–∫–∞, –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ –Ω–∞ Yandex Object Storage

### 5. **Auth**
**–ü—Ä–æ–±–ª–µ–º–∞:** Supabase Auth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –û–°–¢–ê–í–ò–¢–¨! –≠—Ç–æ OK.

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

**–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∫–æ–≥–¥–∞:**
- [ ] `lib/supabase/server.ts`, `admin.ts`, `public-client.ts` —É–¥–∞–ª–µ–Ω—ã
- [ ] `lib/supabase/client.ts` –æ—Å—Ç–∞–ª—Å—è –¢–û–õ–¨–ö–û –¥–ª—è Auth
- [ ] –í—Å–µ –ë–î –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Prisma
- [ ] API routes –Ω–∞ Prisma
- [ ] –•—É–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç API endpoints
- [ ] –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] Prod build —É—Å–ø–µ—à–Ω—ã–π
- [ ] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ

---

## üîß –ò–ù–°–¢–†–£–ú–ï–ù–¢–´

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã Supabase
grep -r "from '@/lib/supabase" --include="*.ts" --include="*.tsx" | wc -l

# –ù–∞–π—Ç–∏ –≤—Å–µ .from( –∑–∞–ø—Ä–æ—Å—ã
grep -r "\.from\(" --include="*.ts" --include="*.tsx" lib/ | grep -v "node_modules"

# –ù–∞–π—Ç–∏ RPC –≤—ã–∑–æ–≤—ã
grep -r "\.rpc\(" --include="*.ts" --include="*.tsx" | grep -v "node_modules"

# –ù–∞–π—Ç–∏ Realtime –ø–æ–¥–ø–∏—Å–∫–∏
grep -r "\.on\('INSERT\|UPDATE\|DELETE" --include="*.ts" --include="*.tsx"
```

---

## üìä –ü–†–û–ì–†–ï–°–°

**–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** –®–ê–ì 1 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:**
- –®–ê–ì 1-2: 1-2 —á–∞—Å–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î, —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü)
- –®–ê–ì 3: 2-3 —á–∞—Å–∞ (ai-service.ts - 1700 —Å—Ç—Ä–æ–∫!)
- –®–ê–ì 4: 1 —á–∞—Å (useProfiles.ts)
- –®–ê–ì 5: 2 —á–∞—Å–∞ (rag.ts - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)
- –®–ê–ì 6: 2-3 —á–∞—Å–∞ (–æ—Å—Ç–∞–ª—å–Ω—ã–µ lib/)
- –®–ê–ì 7: 8-10 —á–∞—Å–æ–≤ (25+ API routes)
- –®–ê–ì 8-9: 2 —á–∞—Å–∞ (cleanup + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ò—Ç–æ–≥–æ:** ~18-23 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –®–ê–ì 1 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –∏ Prisma —Å—Ö–µ–º—ã




