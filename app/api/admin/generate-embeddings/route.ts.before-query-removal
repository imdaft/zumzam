// TODO: MIGRATE QUERIES TO PRISMA
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —á–∞—Å—Ç–∏—á–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç Supabase queries
// –û–Ω–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Prisma

// TODO: MIGRATE TO PRISMA - —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase queries
// –û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Prisma –¥–ª—è consistency

import { NextRequest, NextResponse } from 'next/server'
import prisma from '@/lib/prisma'
import { getUserIdFromRequest } from '@/lib/auth/jwt'
import { logger } from '@/lib/logger'
import { createClient } from '@supabase/supabase-js'
import { generateProfileEmbedding } from '@/lib/ai/generate-profile-embedding'
import { Database } from '@/types/supabase'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

const supabase = createClient<Database>(supabaseUrl, supabaseServiceKey)

export async function POST(request: NextRequest) {
  try {
    const results = {
      profiles: { updated: 0, errors: 0 }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, display_name')
      .order('created_at', { ascending: false })

    logger.info(`üì¶ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${profiles?.length || 0}`)

    for (const profile of profiles || []) {
      try {
        logger.info(`üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–û–õ–ù–û–ì–û embedding –¥–ª—è "${profile.display_name}"...`)
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const embedding = await generateProfileEmbedding(profile.id)

        if (embedding) {
          logger.info(`‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω: "${profile.display_name}"`)
          results.profiles.updated++
        } else {
          logger.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å embedding –¥–ª—è "${profile.display_name}"`)
          results.profiles.errors++
        }

        // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—É–≤–µ–ª–∏—á–µ–Ω–∞ –∏–∑-–∑–∞ –±–æ–ª—å—à–µ–≥–æ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö)
        await new Promise(resolve => setTimeout(resolve, 1500))
      } catch (error: any) {
        logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è "${profile.display_name}":`, error)
        results.profiles.errors++
      }
    }

    return NextResponse.json({
      success: true,
      results
    })
  } catch (error: any) {
    logger.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error)
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

