import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import { generateProfileEmbedding } from '@/lib/ai/generate-profile-embedding'
import { Database } from '@/types/supabase'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

const supabase = createClient<Database>(supabaseUrl, supabaseServiceKey)

export async function POST(request: NextRequest) {
  try {
    const results = {
      profiles: { updated: 0, errors: 0 }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, display_name')
      .order('created_at', { ascending: false })

    console.log(`üì¶ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${profiles?.length || 0}`)

    for (const profile of profiles || []) {
      try {
        console.log(`üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–û–õ–ù–û–ì–û embedding –¥–ª—è "${profile.display_name}"...`)
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const embedding = await generateProfileEmbedding(profile.id)

        if (embedding) {
          console.log(`‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω: "${profile.display_name}"`)
          results.profiles.updated++
        } else {
          console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å embedding –¥–ª—è "${profile.display_name}"`)
          results.profiles.errors++
        }

        // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—É–≤–µ–ª–∏—á–µ–Ω–∞ –∏–∑-–∑–∞ –±–æ–ª—å—à–µ–≥–æ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö)
        await new Promise(resolve => setTimeout(resolve, 1500))
      } catch (error: any) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è "${profile.display_name}":`, error)
        results.profiles.errors++
      }
    }

    return NextResponse.json({
      success: true,
      results
    })
  } catch (error: any) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error)
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

