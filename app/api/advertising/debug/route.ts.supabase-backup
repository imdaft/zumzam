import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

/**
 * GET /api/advertising/debug
 * Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ñ… ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ - Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº?
 */
export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()
    const now = new Date().toISOString()

    console.log('[Debug API] ğŸ” Current time:', now)

    // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ»Ğ¾Ñ‚ home_carousel
    const { data: slot, error: slotError } = await supabase
      .from('ad_slots')
      .select('*')
      .eq('slug', 'home_carousel')
      .single()

    if (slotError || !slot) {
      return NextResponse.json({
        error: 'Ğ¡Ğ»Ğ¾Ñ‚ home_carousel Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!',
        slotError,
        suggestion: 'ĞÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ ad_slots'
      })
    }

    console.log('[Debug API] âœ… Slot found:', slot.id, slot.name)

    // 2. Ğ’ÑĞµ ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
    const { data: allCampaigns, error: campaignsError } = await supabase
      .from('ad_campaigns')
      .select('id, title, status, moderation_status, start_date, end_date')
      .order('created_at', { ascending: false })

    console.log('[Debug API] ğŸ“¦ All campaigns:', allCampaigns?.length || 0)

    // 3. Ğ’ÑĞµ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»Ğ¾Ñ‚Ğ°
    const { data: allBookings, error: bookingsError } = await supabase
      .from('ad_bookings')
      .select(`
        *,
        campaign:ad_campaigns(id, title, status, moderation_status)
      `)
      .eq('ad_slot_id', slot.id)

    console.log('[Debug API] ğŸ“¦ All bookings for slot:', allBookings?.length || 0)

    // 4. ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼)
    const { data: activeBookings, error: activeError } = await supabase
      .from('ad_bookings')
      .select(`
        *,
        campaign:ad_campaigns(
          id,
          title,
          status,
          moderation_status,
          image_url,
          link_url,
          description
        )
      `)
      .eq('ad_slot_id', slot.id)
      .eq('status', 'active')
      .lte('start_date', now)
      .gte('end_date', now)

    console.log('[Debug API] âœ… Active bookings (by date):', activeBookings?.length || 0)

    // 5. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ approved campaigns
    const fullyActive = activeBookings?.filter(
      b => b.campaign?.status === 'active' && b.campaign?.moderation_status === 'approved'
    ) || []

    console.log('[Debug API] âœ… Fully active & approved:', fullyActive.length)

    return NextResponse.json({
      success: true,
      now,
      slot: {
        id: slot.id,
        name: slot.name,
        slug: slot.slug
      },
      stats: {
        totalCampaigns: allCampaigns?.length || 0,
        totalBookingsForSlot: allBookings?.length || 0,
        activeBookingsByDate: activeBookings?.length || 0,
        fullyActiveAndApproved: fullyActive.length
      },
      allCampaigns: allCampaigns?.map(c => ({
        id: c.id,
        title: c.title,
        status: c.status,
        moderation: c.moderation_status,
        start: c.start_date,
        end: c.end_date,
        isInDateRange: c.start_date <= now && c.end_date >= now
      })),
      allBookings: allBookings?.map(b => ({
        id: b.id,
        campaign_id: b.campaign_id,
        campaign_title: (b.campaign as any)?.title,
        campaign_status: (b.campaign as any)?.status,
        campaign_moderation: (b.campaign as any)?.moderation_status,
        booking_status: b.status,
        start: b.start_date,
        end: b.end_date,
        isInDateRange: b.start_date <= now && b.end_date >= now,
        whyNotActive: []
      })).map(b => {
        const reasons = []
        if (b.booking_status !== 'active') reasons.push(`booking_status=${b.booking_status} (Ğ½ÑƒĞ¶Ğ½Ğ¾ active)`)
        if (b.campaign_status !== 'active') reasons.push(`campaign_status=${b.campaign_status} (Ğ½ÑƒĞ¶Ğ½Ğ¾ active)`)
        if (b.campaign_moderation !== 'approved') reasons.push(`moderation=${b.campaign_moderation} (Ğ½ÑƒĞ¶Ğ½Ğ¾ approved)`)
        if (!b.isInDateRange) reasons.push(`Ğ²Ğ½Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ (ÑĞµĞ¹Ñ‡Ğ°Ñ: ${now})`)
        return { ...b, whyNotActive: reasons }
      }),
      fullyActiveBookings: fullyActive.map(b => ({
        campaign_title: (b.campaign as any)?.title,
        image: (b.campaign as any)?.image_url,
        link: (b.campaign as any)?.link_url
      }))
    })
  } catch (error: any) {
    console.error('[Debug API] âŒ Error:', error)
    return NextResponse.json(
      { error: 'Internal error', details: error?.message },
      { status: 500 }
    )
  }
}


