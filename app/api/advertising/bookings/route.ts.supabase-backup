import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

/**
 * POST /api/advertising/bookings
 * –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
 */
export async function POST(request: NextRequest) {
  try {
    console.log('[Bookings API] üöÄ POST request received')
    const supabase = await createClient()

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      console.log('[Bookings API] ‚ùå Auth error:', authError)
      return NextResponse.json(
        { error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' },
        { status: 401 }
      )
    }

    console.log('[Bookings API] ‚úÖ User authenticated:', user.id)

    const body = await request.json()
    console.log('[Bookings API] üì¶ Request body:', body)

    const {
      campaign_id,
      ad_slot_id,
      start_date,
      end_date,
      total_cost,
      status = 'pending'
    } = body

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!campaign_id || !ad_slot_id || !start_date || !end_date || !total_cost) {
      console.log('[Bookings API] ‚ùå Validation failed')
      return NextResponse.json(
        { error: '–ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã' },
        { status: 400 }
      )
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–º–ø–∞–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const { data: campaign } = await supabase
      .from('ad_campaigns')
      .select('user_id')
      .eq('id', campaign_id)
      .single()

    if (!campaign || campaign.user_id !== user.id) {
      console.log('[Bookings API] ‚ùå Campaign not found or access denied')
      return NextResponse.json(
        { error: '–ö–∞–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' },
        { status: 403 }
      )
    }

    console.log('[Bookings API] üíæ Inserting booking into DB...')

    // –°–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    const { data: booking, error } = await supabase
      .from('ad_bookings')
      .insert({
        campaign_id,
        ad_slot_id,
        start_date,
        end_date,
        total_cost,
        status
      })
      .select()
      .single()

    if (error) {
      console.error('[Bookings API] ‚ùå DB Error creating booking:', error)
      return NextResponse.json(
        { error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', details: error.message },
        { status: 500 }
      )
    }

    console.log('[Bookings API] ‚úÖ Booking created successfully:', booking.id)
    return NextResponse.json({ booking }, { status: 201 })
  } catch (error: any) {
    console.error('[Bookings API] ‚ùå Unexpected error:', error)
    return NextResponse.json(
      { error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', details: error?.message },
      { status: 500 }
    )
  }
}


