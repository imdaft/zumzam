// TODO: MIGRATE TO PRISMA - —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase queries
// –û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Prisma –¥–ª—è consistency

import { NextRequest, NextResponse } from 'next/server'
import prisma from '@/lib/prisma'
import { verifyToken } from '@/lib/auth/jwt'
import { GoogleGenerativeAI } from '@google/generative-ai'
import { addToCart, removeFromCart, showCart, clearCart } from '@/lib/ai/cart-utils'

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '')

const DEFAULT_CITY = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'
const CURRENT_YEAR = new Date().getFullYear()
const REQUIRED_FIELDS = [
  'category',
  'eventDate',
  'eventTime',
  'city_or_address',
  'venueType',
  'budget_or_negotiable',
  'clientType',
  'contactPhone',
] as const

type DraftType = {
  category?: string
  title?: string
  description?: string
  eventDate?: string
  eventTime?: string
  city?: string
  district?: string
  address?: string
  venueType?: string
  budget?: number
  budgetNegotiable?: boolean
  clientType?: string
  childrenCount?: number
  childrenAgeRange?: { from?: number; to?: number }
  birthdayChild?: { name?: string; age?: number }
  contactName?: string
  contactPhone?: string
  contactMethod?: string
  preferredContactTime?: string
  details?: Record<string, unknown>
}

function buildDraftPrompt(userText: string) {
  return `–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–π —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —É—Å–ª—É–≥—É –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.

–í—Ö–æ–¥: –æ–¥–∏–Ω –∞–±–∑–∞—Ü —Å –¥–µ—Ç–∞–ª—è–º–∏ (–¥–∞—Ç–∞, –≤—Ä–µ–º—è, –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞, –±—é–¥–∂–µ—Ç, –∞–¥—Ä–µ—Å, —Ñ–æ—Ä–º–∞—Ç).
–ù–∞–¥–æ –∏–∑–≤–ª–µ—á—å –ø–æ–ª—è –∏ –≤–µ—Ä–Ω—É—Ç—å –°–¢–†–û–ì–û JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–ü–æ–ª–µ category –≤—ã–±–µ—Ä–∏ –∏–∑: animator, show, quest, masterclass, host, photo_video, santa, face_painting, costume, other.
–ü–æ–ª–µ venueType –≤—ã–±–µ—Ä–∏ –∏–∑: home, restaurant, kids_center, club, outdoor, school, office, other.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
{
  "category": "show",
  "title": "–§–æ–∫—É—Å–Ω–∏–∫ –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
  "description": "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –≤–æ–¥—ã",
  "eventDate": "2025-12-25",
  "eventTime": "17:00",
  "city": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
  "district": "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π",
  "address": "–†–µ—Å—Ç–æ—Ä–∞–Ω –†—ã–±–∞ –Ω–∞ –¥–∞—á–µ",
  "venueType": "restaurant",
  "budget": 15000,
  "budgetNegotiable": false,
  "childrenCount": 10,
  "childrenAgeRange": { "from": 10, "to": 10 },
  "birthdayChild": { "name": "–ò–≥–æ—Ä—å", "age": 10 },
  "contactName": "–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ",
  "contactPhone": "+7...",
  "details": { "keywords": ["—Ñ–æ–∫—É—Å—ã", "–≤—ã–µ–∑–¥ –∑–∞ –≥–æ—Ä–æ–¥"] }
}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≤—Ä–µ–º—è HH:MM (24h), –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º.
- –ë—é–¥–∂–µ—Ç —á–∏—Å–ª–æ–º (–±–µ–∑ –≤–∞–ª—é—Ç—ã –∏ —Å–ª–æ–≤).
- –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ—Å—Ç–∞–≤—å "${DEFAULT_CITY}".
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –ø–æ–ª–µ–π. –¢–æ–ª—å–∫–æ JSON.`
}

function safeParseDraft(text: string | null): DraftType | null {
  if (!text) return null
  try {
    const start = text.indexOf('{')
    const end = text.lastIndexOf('}')
    if (start === -1 || end === -1) return null
    const jsonText = text.slice(start, end + 1)
    return JSON.parse(jsonText) as DraftType
  } catch (error) {
    console.error('[AI Chat Draft] parse error', error)
    return null
  }
}

function normalizeDraft(draft: DraftType): DraftType {
  return {
    category: draft.category || 'show',
    title: draft.title || '–ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫',
    description: draft.description,
    eventDate: draft.eventDate,
    eventTime: draft.eventTime,
    city: draft.city || DEFAULT_CITY,
    district: draft.district,
    address: draft.address,
    venueType: draft.venueType || 'home',
    clientType: draft.clientType || 'parent',
    contactMethod: draft.contactMethod || 'chat',
    preferredContactTime: draft.preferredContactTime || 'any',
    budget: typeof draft.budget === 'number' ? draft.budget : undefined,
    budgetNegotiable: draft.budgetNegotiable ?? false,
    childrenCount: draft.childrenCount,
    childrenAgeRange: draft.childrenAgeRange,
    birthdayChild: draft.birthdayChild,
    contactName: draft.contactName,
    contactPhone: draft.contactPhone,
    details: draft.details || {},
  }
}

function missingFields(draft: DraftType) {
  const missing: string[] = []
  if (!draft.eventDate) missing.push('–¥–∞—Ç—É')
  if (!draft.eventTime) missing.push('–≤—Ä–µ–º—è')
  if (!draft.address && !draft.city) missing.push('–∞–¥—Ä–µ—Å/–≥–æ—Ä–æ–¥')
  if (!draft.category) missing.push('–∫–∞—Ç–µ–≥–æ—Ä–∏—é')
  if (!draft.budget && !draft.budgetNegotiable) missing.push('–±—é–¥–∂–µ—Ç')
  if (!draft.venueType) missing.push('—Ç–∏–ø –ø–ª–æ—â–∞–¥–∫–∏')
  if (!draft.clientType) missing.push('–∫—Ç–æ –≤—ã (—Ä–æ–¥–∏—Ç–µ–ª—å/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä/–ø–ª–æ—â–∞–¥–∫–∞)')
  return missing
}

function optionalMissing(draft: DraftType) {
  const missing: string[] = []
  if (!draft.childrenCount && !draft.childrenAgeRange) missing.push('–≤–æ–∑—Ä–∞—Å—Ç/–∫–æ–ª-–≤–æ –¥–µ—Ç–µ–π')
  if (!draft.description) missing.push('–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã')
  if (!draft.contactPhone) missing.push('—Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏')
  return missing
}

function makeSummary(draft: DraftType) {
  const parts = [
    draft.eventDate ? `üìÖ ${draft.eventDate}` : null,
    draft.eventTime ? `‚è∞ ${draft.eventTime}` : null,
    draft.city ? `üìç ${draft.city}${draft.address ? ', ' + draft.address : ''}` : draft.address ? `üìç ${draft.address}` : null,
    draft.budget ? `üí∞ ${draft.budget.toLocaleString('ru-RU')} ‚ÇΩ` : draft.budgetNegotiable ? 'üí∞ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è' : null,
    draft.category ? `üß© ${draft.category}` : null,
  ].filter(Boolean)
  return parts.join(' ‚Ä¢ ')
}

function encodePrefill(draft: DraftType) {
  try {
    return Buffer.from(JSON.stringify(draft), 'utf-8').toString('base64url')
  } catch {
    return null
  }
}

function hasAnyDate(text: string) {
  return (
    /\b\d{4}-\d{2}-\d{2}\b/.test(text) || // 2025-12-25
    /\b\d{1,2}[./]\d{1,2}\b/.test(text) || // 25.12
    /\b\d{1,2}\s?(—è–Ω–≤|—Ñ–µ–≤|–º–∞—Ä|–∞–ø—Ä|–º–∞[–π—è]|–∏—é–Ω|–∏—é–ª|–∞–≤–≥|—Å–µ–Ω|oct|–æ–∫—Ç|–Ω–æ—è|–¥–µ–∫)\w*/i.test(text)
  )
}

function hasAnyTime(text: string) {
  return /\b\d{1,2}[:.]\d{2}\b/.test(text)
}

function hasAnyBudget(text: string) {
  return /\b\d{3,}\b/.test(text) || /–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(text)
}

function hasAnyRole(text: string) {
  return /(–∞–Ω–∏–º–∞—Ç–æ—Ä|—Ñ–æ–∫—É—Å–Ω–∏–∫|–≤–µ–¥—É—â|–∫–≤–µ—Å—Ç|—à–æ—É|—Ñ–æ—Ç–æ|–≤–∏–¥–µ–æ|–¥–µ–¥\s?–º–æ—Ä–æ–∑|—Å–Ω–µ–≥—É—Ä–æ—á–∫|—Ä–æ—Å—Ç–æ–≤(–∞—è|–æ–π)|–º–∞—Å—Ç–µ—Ä-?–∫–ª–∞—Å—Å|–∫–ª–æ—É–Ω|—Ñ–µ–π|–ø—Ä–∏–Ω—Ü–µ—Å—Å|—Ñ–µ–π–µ—Ä–≤–µ—Ä–∫|–∏–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç)/i.test(text)
}

function hasAnyPlace(text: string) {
  return /(—É–ª\.|—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø|–ø—Ä-—Ç|–ø–ª\.|–º–µ—Ç—Ä–æ|—Ä–µ—Å—Ç–æ—Ä–∞–Ω|–∫–∞—Ñ–µ|–ø–∞—Ä–∫|–ª–æ—Ñ—Ç|—Å—Ç—É–¥–∏—è|–∑–∞–≥–æ—Ä–æ–¥|–∑–∞ –≥–æ—Ä–æ–¥–æ–º|–∫–æ—Ç—Ç–µ–¥–∂|–ø–æ—Å[–µ—ë]–ª–æ–∫|–¥–µ—Ä–µ–≤–Ω|—Å–ø–±|—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥|–º–æ—Å–∫–≤–∞|–º–æ\b|–ª–µ–Ω–æ–±–ª|–∞–¥—Ä–µ—Å)/i.test(text)
}

function detectCategory(text: string): string | undefined {
  if (/—Ñ–æ–∫—É—Å–Ω–∏–∫|–∏–ª–ª—é–∑/i.test(text)) return 'show'
  if (/–∞–Ω–∏–º–∞—Ç–æ—Ä|–≥–µ—Ä–æ|–ø–µ—Ä—Å–æ–Ω–∞–∂|—Ä–æ—Å—Ç–æ–≤/i.test(text)) return 'animator'
  if (/–≤–µ–¥—É—â/i.test(text)) return 'host'
  if (/–∫–≤–µ—Å—Ç/i.test(text)) return 'quest'
  if (/–º–∞—Å—Ç–µ—Ä[- ]?–∫–ª–∞—Å—Å|–ú–ö/i.test(text)) return 'masterclass'
  if (/—Ñ–æ—Ç–æ|–≤–∏–¥–µ–æ|—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ|–≤–∏–¥–µ–æ–≥—Ä–∞—Ñ/i.test(text)) return 'photo_video'
  if (/–¥–µ–¥\s?–º–æ—Ä–æ–∑|—Å–Ω–µ–≥—É—Ä–æ—á/i.test(text)) return 'santa'
  return undefined
}

function parseBudget(text: string): number | undefined {
  // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ 12:00, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å —Å –±—é–¥–∂–µ—Ç–æ–º
  const cleanedText = text.replace(/\b\d{1,2}[:.]\d{2}\b/g, ' ')
  const matches = cleanedText.match(/(\d[\d\s.,]{2,})/g)
  if (!matches) return undefined
  const numbers = matches
    .map((m) => m.replace(/\s/g, '').replace(/[,\.]/g, ''))
    .map((m) => parseInt(m, 10))
    .filter((n) => Number.isFinite(n))
    .filter((n) => n >= 500) // –æ—Ç—Å–µ–∫–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –≤—Ä–µ–º—è/–º–µ–ª–∫–∏–µ —á–∏—Å–ª–∞
  if (numbers.length === 0) return undefined
  // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç
  return Math.max(...numbers)
}

function parseTime(text: string): string | undefined {
  // 1) –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è 10:30, 10.30
  const full = text.match(/\b(\d{1,2})[:.](\d{2})\b/)
  if (full) {
    const hh = full[1].padStart(2, '0')
    const mm = full[2]
    return `${hh}:${mm}`
  }

  // 2) –§–æ—Ä–º–∞—Ç "–≤ 10 —É—Ç—Ä–∞/–≤–µ—á–µ—Ä–∞/–¥–Ω—è/–Ω–æ—á–∏" –∏–ª–∏ "10 —É—Ç—Ä–∞"
  const withMeridiem = text.match(/\b(?:–≤\s*)?(\d{1,2})\s*(—É—Ç—Ä–∞|–≤–µ—á–µ—Ä–∞|–¥–Ω—è|–Ω–æ—á–∏)\b/i)
  if (withMeridiem) {
    let hhNum = parseInt(withMeridiem[1], 10)
    const meridiem = withMeridiem[2].toLowerCase()
    if (meridiem.includes('–≤–µ—á–µ—Ä') || meridiem.includes('–Ω–æ—á–∏')) {
      if (hhNum < 12) hhNum += 12
    }
    // "–¥–Ω—è" –æ–±—ã—á–Ω–æ –¥–Ω–µ–≤–Ω–æ–µ –≤—Ä–µ–º—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    const hh = hhNum.toString().padStart(2, '0')
    return `${hh}:00`
  }

  // 3) –§–æ—Ä–º–∞—Ç "–≤ 10" (—Ç—Ä–µ–±—É–µ–º –ø—Ä–µ–¥–ª–æ–≥ "–≤", —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å —á–∏—Å–ª–∞ –¥–∞—Ç—ã)
  const hourOnly = text.match(/\b–≤\s*(\d{1,2})\b/i)
  if (hourOnly) {
    const hh = hourOnly[1].padStart(2, '0')
    return `${hh}:00`
  }

  return undefined
}

function parseDate(text: string): string | undefined {
  const monthMap: Record<string, number> = {
    —è–Ω–≤: 0, —Ñ–µ–≤: 1, –º–∞—Ä: 2, –∞–ø—Ä: 3, –º–∞—è: 4, –º–∞–π: 4, –∏—é–Ω: 5, –∏—é–ª: 6, –∞–≤–≥: 7, —Å–µ–Ω: 8, –æ–∫—Ç: 9, –æ–∫—Ç—è: 9, –Ω–æ—è: 10, –¥–µ–∫: 11,
  }
  const dot = text.match(/\b(\d{1,2})[./](\d{1,2})(?:[./](\d{2,4}))?\b/)
  if (dot) {
    const day = parseInt(dot[1], 10)
    const mon = parseInt(dot[2], 10) - 1
    const year = dot[3] ? parseInt(dot[3], 10) + (dot[3].length === 2 ? 2000 : 0) : CURRENT_YEAR
    if (day >= 1 && day <= 31 && mon >= 0 && mon <= 11) {
      return `${year}-${(mon + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`
    }
  }
  const words = text.match(/\b(\d{1,2})\s?(—è–Ω–≤|—Ñ–µ–≤|–º–∞—Ä|–∞–ø—Ä|–º–∞[–π—è]|–∏—é–Ω|–∏—é–ª|–∞–≤–≥|—Å–µ–Ω|–æ–∫—Ç|–Ω–æ—è|–¥–µ–∫)\w*/i)
  if (words) {
    const day = parseInt(words[1], 10)
    const monKey = words[2].slice(0, 3).toLowerCase()
    const mon = monthMap[monKey]
    if (mon !== undefined) {
      let year = CURRENT_YEAR
      // –µ—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞, –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
      const today = new Date()
      const candidate = new Date(year, mon, day)
      if (candidate.getTime() < today.getTime()) {
        year += 1
      }
      return `${year}-${(mon + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`
    }
  }
  return undefined
}

function parseAddress(text: string): { city?: string; address?: string } {
  let city: string | undefined
  if (/–º–æ—Å–∫–≤/i.test(text)) city = '–ú–æ—Å–∫–≤–∞'
  if (/—Å–ø–±|—Å–∞–Ω–∫—Ç[- ]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|–ø–∏—Ç–µ—Ä/i.test(text)) city = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'
  // –≥—Ä—É–±–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–æ—Å–ª–µ "–≤ " –¥–æ –∑–∞–ø—è—Ç–æ–π/—Ç–æ—á–∫–∏
  const addrMatch = text.match(/–≤\s+([A-Za-z–ê-–Ø–∞-—è0-9"¬´¬ª\s\-]+?)(?:[,\.]|$)/i)
  const address = addrMatch ? addrMatch[1].trim() : undefined
  return { city, address }
}

function parseChildrenCount(text: string): number | undefined {
  const matches: number[] = []
  const patterns = [
    /(?:–¥–µ—Ç[–µ–∏]|–¥–µ—Ç—è–º|–¥–µ—Ç–∫–∞–º|—Ä–µ–±—è—Ç|—á–µ–ª–æ–≤–µ–∫|—á–µ–ª)\s*(?:–±—É–¥–µ—Ç|–±—É–¥—É—Ç|–æ–∫–æ–ª–æ|–ø—Ä–∏–º–µ—Ä–Ω–æ|~)?\s*(\d{1,3})/gi,
    /(\d{1,3})\s*(?:–¥–µ—Ç[–µ–∏]|–¥–µ—Ç—è–º|–¥–µ—Ç–∫–∞–º|—á–µ–ª–æ–≤–µ–∫|—á–µ–ª|—Ä–µ–±—è—Ç)/gi,
    /–¥–µ—Ç–µ–π\s*[\.,]?\s*(\d{1,3})/gi,
  ]

  for (const re of patterns) {
    let m: RegExpExecArray | null
    while ((m = re.exec(text)) !== null) {
      const num = parseInt(m[1], 10)
      if (Number.isFinite(num)) matches.push(num)
    }
  }

  if (matches.length === 0) return undefined
  return Math.max(...matches)
}

function parseChildrenAge(text: string): { from?: number; to?: number; single?: number } | undefined {
  const m = text.match(/(\d{1,2})\s*(?:–ª–µ—Ç|–≥–æ–¥[–∞—É]?)/i)
  if (m) {
    const age = parseInt(m[1], 10)
    if (Number.isFinite(age)) {
      return { from: age, to: age, single: age }
    }
  }
  // –î–∏–∞–ø–∞–∑–æ–Ω –≤–∏–¥–∞ 5-8 –ª–µ—Ç
  const m2 = text.match(/(\d{1,2})\s*[-‚Äì]\s*(\d{1,2})\s*(?:–ª–µ—Ç|–≥–æ–¥)/i)
  if (m2) {
    const from = parseInt(m2[1], 10)
    const to = parseInt(m2[2], 10)
    if (Number.isFinite(from) && Number.isFinite(to)) {
      return { from, to }
    }
  }
  return undefined
}

function parseVenueType(text: string): string | undefined {
  if (/—Ä–µ—Å—Ç–æ—Ä–∞–Ω|–∫–∞—Ñ–µ|–±–∞–Ω–∫–µ—Ç/i.test(text)) return 'restaurant'
  if (/–∫–≤–∞—Ä—Ç–∏—Ä–∞|–¥–æ–º–∞|–¥–æ–º|–∫–æ—Ç—Ç–µ–¥–∂|–∑–∞–≥–æ—Ä–æ–¥|–Ω–∞ –¥–æ–º—É/i.test(text)) return 'home'
  if (/–ø–∞—Ä–∫|—É–ª–∏—Ü|open\s?air|–Ω–∞ —É–ª–∏—Ü–µ/i.test(text)) return 'outdoor'
  if (/—à–∫–æ–ª|—Å–∞–¥–∏–∫|–¥–µ—Ç—Å–∫–∏–π —Å–∞–¥/i.test(text)) return 'school'
  if (/–æ—Ñ–∏—Å/i.test(text)) return 'office'
  if (/–ª–æ—Ñ—Ç|—Å—Ç—É–¥–∏—è|–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤/i.test(text)) return 'other'
  if (/–∫–ª—É–±/i.test(text)) return 'club'
  return undefined
}

function detectShowType(text: string): string | undefined {
  if (/—Ñ–æ–∫—É—Å/i.test(text)) return 'magic'
  if (/—à–æ—É/i.test(text)) return 'magic'
  return undefined
}

function buildTitle(text: string, category?: string): string | undefined {
  if (category === 'show' && /—Ñ–æ–∫—É—Å/i.test(text)) return '–§–æ–∫—É—Å–Ω–∏–∫ –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫'
  return undefined
}

function buildDescription(primaryText: string): string | undefined {
  const cleaned = primaryText
    .replace(/—Å–æ–∑–¥–∞–π\s+–æ–±—ä—è–≤–ª–µ–Ω–∏–µ[:,]?\s*/i, '')
    .replace(/—Å–¥–µ–ª–∞–π\s+–æ–±—ä—è–≤–ª–µ–Ω–∏–µ[:,]?\s*/i, '')
    .replace(/–Ω—É–∂–µ–Ω\s+—Ñ–æ–∫—É—Å–Ω–∏–∫[:,]?\s*/i, '')
    .trim()
  if (!cleaned) return undefined
  return cleaned.slice(0, 300)
}

function parsePhone(text: string): string | undefined {
  const cleanDigits = text.replace(/[^\d+]/g, '')
  // +7XXXXXXXXXX or 8XXXXXXXXXX or 11 digits
  const m = cleanDigits.match(/(\+7|7|8)?\d{10}/)
  if (!m) return undefined
  let digits = m[0]
  if (digits.startsWith('8')) digits = '+7' + digits.slice(1)
  if (digits.startsWith('7')) digits = '+7' + digits.slice(1)
  if (!digits.startsWith('+7')) digits = '+7' + digits
  return digits
}

function normalizePhone(phone?: string): string | undefined {
  if (!phone) return undefined
  const clean = phone.replace(/[^\d+]/g, '')
  const m = clean.match(/(\+7|7|8)?\d{10}/)
  if (!m) return undefined
  let digits = m[0]
  if (digits.startsWith('8')) digits = '+7' + digits.slice(1)
  if (digits.startsWith('7')) digits = '+7' + digits.slice(1)
  if (!digits.startsWith('+7')) digits = '+7' + digits
  return digits
}

function parseDraftQuick(primaryText: string, contextText?: string): DraftType {
  const base = primaryText
  const fallback = contextText && contextText !== primaryText ? contextText : ''
  const combined = `${base}\n${fallback}`.trim()

  // –í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–µ–º—Å—è –±—Ä–∞—Ç—å –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  const pick = <T>(primary: T | undefined, fallbackValue: T | undefined) =>
    primary !== undefined && primary !== null ? primary : fallbackValue

  const category = pick(detectCategory(base), detectCategory(fallback))
  const budget =
    pick(parseBudget(base), parseBudget(fallback)) ??
    parseBudget(combined)
  const budgetNegotiable =
    pick(/–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(base) ? true : undefined, /–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(fallback) ? true : undefined) ??
    (/–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(combined) ? true : undefined)
  const eventTime = pick(parseTime(base), parseTime(fallback)) ?? parseTime(combined)
  const eventDate = pick(parseDate(base), parseDate(fallback)) ?? parseDate(combined)

  const primaryAddr = parseAddress(base)
  const fallbackAddr = parseAddress(fallback)
  const city = pick(primaryAddr.city, fallbackAddr.city)
  const address = pick(primaryAddr.address, fallbackAddr.address)

  const childrenCount = pick(parseChildrenCount(base), parseChildrenCount(fallback))
  const ageData = pick(parseChildrenAge(base), parseChildrenAge(fallback))
  const venueType = pick(parseVenueType(base), parseVenueType(fallback))
  const showType = pick(detectShowType(base), detectShowType(fallback))
  const title = pick(buildTitle(base, category), buildTitle(fallback, category))
  const description = pick(buildDescription(base), buildDescription(fallback))
  const contactPhone = parsePhone(primaryText)

  return {
    category,
    budget,
    budgetNegotiable: budgetNegotiable ?? /–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(primaryText),
    eventDate,
    eventTime,
    city: city || (address ? DEFAULT_CITY : undefined),
    address,
    venueType,
    clientType: 'parent',
    childrenCount,
    childrenAgeRange: ageData
      ? { from: ageData.from ?? ageData.single, to: ageData.to ?? ageData.single }
      : undefined,
    birthdayChild: ageData?.single ? { age: ageData.single } : undefined,
    details: showType ? { showType } : undefined,
    title,
    description,
    contactMethod: 'chat',
    preferredContactTime: 'any',
    contactPhone,
  }
}

/**
 * AI Chat Endpoint —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Gemini –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ Supabase pgvector –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
 */
export async function POST(request: NextRequest) {
  try {
    const { message, conversationHistory = [], currentProfileId } = await request.json()

    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' },
        { status: 400 }
      )
    }

    // Supabase client removed
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: { user } } = await supabase.auth.getUser()
    let userPhone = normalizePhone(
      user?.phone ||
      user?.user_metadata?.phone ||
      user?.user_metadata?.phone_number ||
      user?.user_metadata?.phoneNumber
    )
    
    let isAdmin = false

    if (user) {
      // –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –æ—Ç–∫–ª—é—á–∞–µ–º –ª–∏–º–∏—Ç)
      const { data: userData } = await supabase
        .from('users')
        .select('role')
        .eq('id', userId)
        .single()

      isAdmin = userData?.role === 'admin'

      // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ—Ç –≤ auth, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
      if (!userPhone) {
        const { data: profilePhone } = await supabase
          .from('profiles')
          .select('phone')
          .eq('user_id', userId)
          .limit(1)
          .maybeSingle()

        if (profilePhone?.phone) {
          userPhone = normalizePhone(profilePhone.phone)
        }
      }

      if (isAdmin) {
        // –ê–¥–º–∏–Ω—ã –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤
      } else {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit
      const { data: rateLimit } = await supabase
        .from('ai_chat_rate_limits')
        .select('*')
        .eq('user_id', userId)
        .single()

      const now = new Date()
      const hourAgo = new Date(now.getTime() - 60 * 60 * 1000)

      if (rateLimit) {
        const lastMessageTime = new Date(rateLimit.last_message_at)
        
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ–ª—å—à–µ —á–∞—Å–∞ –Ω–∞–∑–∞–¥, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
        if (lastMessageTime < hourAgo) {
          await supabase
            .from('ai_chat_rate_limits')
            .update({ message_count: 1, last_message_at: now.toISOString() })
            .eq('user_id', userId)
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç (20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Å)
          if (rateLimit.message_count >= 20) {
            const retryAfterSeconds = 3600
            const retryAt = new Date(now.getTime() + retryAfterSeconds * 1000)
            return NextResponse.json(
              { 
                error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ üòä', 
                retry_after: retryAfterSeconds, 
                retry_at_iso: retryAt.toISOString()
              },
              { status: 429 }
            )
          }

          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
          await supabase
            .from('ai_chat_rate_limits')
            .update({ 
              message_count: rateLimit.message_count + 1, 
              last_message_at: now.toISOString() 
            })
            .eq('user_id', userId)
        }
      } else {
        // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        await supabase
          .from('ai_chat_rate_limits')
          .insert({ 
            user_id: userId, 
            message_count: 1, 
            last_message_at: now.toISOString() 
          })
      }
    }
    }

    // –ë–ª–æ–∫: –±—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä ¬´—Å–æ–∑–¥–∞–π –æ–±—ä—è–≤–ª–µ–Ω–∏–µ/–∑–∞—è–≤–∫—É¬ª
    const normalizedMsg = message.toLowerCase()
    const isDraftTrigger = /(—Å–æ–∑–¥–∞–π|—Å–æ–∑–¥–∞—Ç—å|—Å–¥–µ–ª–∞–π|—Å–æ–±–µ—Ä–∏|–æ—Ñ–æ—Ä–º–∏|—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π).{0,10}(–æ–±—ä—è–≤–ª–µ–Ω|–∑–∞—è–≤–∫)/i.test(normalizedMsg)

    const lastAssistant = [...(conversationHistory || [])].reverse().find((m: any) => m.role === 'assistant')
    const pendingDraft =
      lastAssistant &&
      /–ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ|–Ω—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è|—á–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞—è–≤–∫–∏|—Å–æ–±—Ä–∞–ª —á–µ—Ä–Ω–æ–≤–∏–∫|–≥–æ—Ç–æ–≤ —á–µ—Ä–Ω–æ–≤–∏–∫|—Å–æ–±–µ—Ä—É —Å—Å—ã–ª–∫—É/i.test(
        lastAssistant.content || ''
      )

    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–µ—Ç–∞–ª–∏
    const userContext = [
      ...(conversationHistory || [])
        .filter((m: any) => m.role === 'user')
        .slice(-5)
        .map((m: any) => m.content || ''),
      message,
    ]
      .filter(Boolean)
      .join('. ')

  // –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å –¥–æ —Ä–µ—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, —á—Ç–æ —ç—Ç–æ —Ç–æ—á–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    const quickPrecheck = parseDraftQuick(message, userContext)
    const likelyDraft =
      !!quickPrecheck.category &&
      !!quickPrecheck.eventDate &&
      (!!quickPrecheck.budget || quickPrecheck.budgetNegotiable) &&
      (!!quickPrecheck.address || !!quickPrecheck.city)

    const isDraftFlow = isDraftTrigger || pendingDraft || likelyDraft

    if (isDraftFlow) {
      // –ü—Ä–∞–≤–∏–ª–æ: —Å–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–µ—Ä, –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const quick = quickPrecheck
      const hasDate = !!quick.eventDate
      const hasTime = !!quick.eventTime
      const hasBudget = !!quick.budget || quick.budgetNegotiable
      const hasRole = !!quick.category
      const hasPlace = !!quick.address || !!quick.city
      const detailsScore = [hasDate, hasTime, hasBudget, hasRole, hasPlace].filter(Boolean).length

      // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—é—â–∏–π—Å—è –¥–∏–∞–ª–æ–≥ (–Ω–µ—Ç pendingDraft/likelyDraft), –∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤—Å–µ–º –º–∞–ª–æ ‚Äî –ø—Ä–æ—Å–∏–º –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä
      if (!pendingDraft && !likelyDraft && (message.trim().length < 25 || detailsScore < 2)) {
        return NextResponse.json({
          response:
            '–ß—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫, —É–∫–∞–∂–∏—Ç–µ –≤ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–µ: –¥–∞—Ç—É, –≤—Ä–µ–º—è, –∫–æ–≥–æ –∏—â–µ–º, –∞–¥—Ä–µ—Å/–≥–æ—Ä–æ–¥ –∏ –±—é–¥–∂–µ—Ç. –ü—Ä–∏–º–µ—Ä: "25 –¥–µ–∫–∞–±—Ä—è 17:00 —Ñ–æ–∫—É—Å–Ω–∏–∫, —Ä–µ—Å—Ç–æ—Ä–∞–Ω –†—ã–±–∞ –Ω–∞ –¥–∞—á–µ, –±—é–¥–∂–µ—Ç 15000".',
          suggestions: [
            '25 –¥–µ–∫–∞–±—Ä—è 17:00 —Ñ–æ–∫—É—Å–Ω–∏–∫, —Ä–µ—Å—Ç–æ—Ä–∞–Ω –†—ã–±–∞ –Ω–∞ –¥–∞—á–µ, –±—é–¥–∂–µ—Ç 15000',
            '31 –¥–µ–∫–∞–±—Ä—è 19:30 –∞–Ω–∏–º–∞—Ç–æ—Ä –≠–ª—å–∑–∞, –ö–æ–º–µ–Ω–¥–∞–Ω—Ç—Å–∫–∏–π, –¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è',
            '–°—É–±–±–æ—Ç–∞ 12:00 –∫–≤–µ—Å—Ç –Ω–∞ —É–ª–∏—Ü–µ, –ü—É—à–∫–∏–Ω, –¥–æ 20000',
          ],
          gallery: [],
        })
      }

      const draft = normalizeDraft(quick)

      // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –±—é–¥–∂–µ—Ç –Ω–µ —Ä–∞–∑–æ–±—Ä–∞–Ω, —Ç—è–Ω–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      if (!draft.budget && !draft.budgetNegotiable) {
        const ctxBudget = parseBudget(userContext)
        if (ctxBudget) draft.budget = ctxBudget
        if (draft.budgetNegotiable === undefined) {
          draft.budgetNegotiable = /–¥–æ–≥–æ–≤–æ—Ä–Ω/i.test(userContext) || draft.budgetNegotiable
        }
      }

      // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
      if (!draft.contactPhone && userPhone) {
        draft.contactPhone = userPhone
      }
      const lacks = missingFields(draft)
      const softLacks = optionalMissing(draft)

      // –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –Ω–µ –∏–¥—ë–º –¥–∞–ª—å—à–µ
      if (lacks.length > 0) {
        return NextResponse.json({
          response: `–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ—Ç–∞–ª–µ–π: ${lacks.join(', ')}. –ù–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π, –∏ —Å–æ–±–µ—Ä—É —Å—Å—ã–ª–∫—É –Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫.`,
          suggestions: ['–î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º—è', '–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å', '–°—É–º–º–∞ –±—é–¥–∂–µ—Ç–∞'],
          gallery: [],
        })
      }

      // –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º—è–≥–∫–∏—Ö –ø–æ–ª–µ–π ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –Ω–µ –∏–¥—ë–º –¥–∞–ª—å—à–µ
      if (softLacks.length > 0) {
        return NextResponse.json({
          response: `–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ. –ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è: ${softLacks.join(', ')}. –ù–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π, –∏ —Å—Ä–∞–∑—É —Å–æ–±–µ—Ä—É —Å—Å—ã–ª–∫—É –Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫.`,
          suggestions: ['–î–µ—Ç–µ–π 10-12 –ª–µ—Ç, 15 —á–µ–ª–æ–≤–µ–∫', '–û–ø–∏—Å–∞–Ω–∏–µ: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ —Å —Ñ–æ–∫—É—Å–∞–º–∏ –∏ —É—á–∞—Å—Ç–∏–µ–º –¥–µ—Ç–µ–π', '–¢–µ–ª–µ—Ñ–æ–Ω: +7 ...'],
          gallery: [],
        })
      }

      // –í—Å–µ –ø–æ–ª—è –µ—Å—Ç—å ‚Äî —Å—Ä–∞–∑—É –æ—Ç–¥–∞—ë–º —Å—Å—ã–ª–∫—É
      const encoded = Buffer.from(JSON.stringify(draft), 'utf-8').toString('base64url')
      const link = `/create-request?prefill=${encoded}`
      const summaryParts = [
        draft.eventDate ? `üìÖ ${draft.eventDate}` : null,
        draft.eventTime ? `‚è∞ ${draft.eventTime}` : null,
        draft.city ? `üìç ${draft.city}${draft.address ? ', ' + draft.address : ''}` : draft.address ? `üìç ${draft.address}` : null,
        draft.budget ? `üí∞ ${draft.budget.toLocaleString('ru-RU')} ‚ÇΩ` : draft.budgetNegotiable ? 'üí∞ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è' : null,
        draft.category ? `üß© ${draft.category}` : null,
      ].filter(Boolean)

      return NextResponse.json({
        response: `–°–æ–±—Ä–∞–ª —á–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞—è–≤–∫–∏.\n\n${summaryParts.join(' ‚Ä¢ ')}\n\n[–û—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫](${link}) ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ.`,
        suggestions: ['–ò–∑–º–µ–Ω–∏—Ç—å –±—é–¥–∂–µ—Ç', '–ü–æ–º–µ–Ω—è—Ç—å –≤—Ä–µ–º—è', '–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã'],
        gallery: [],
      })
    }

    // –®–∞–≥ 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º Gemini –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ embedding
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' })
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º embedding –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    const embeddingModel = genAI.getGenerativeModel({ model: 'text-embedding-004' })
    const embeddingResult = await embeddingModel.embedContent(message)
    const embedding = embeddingResult.embedding.values
    
    // –®–∞–≥ 1.5: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
    let currentPageProfile = null
    if (currentProfileId) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('id, display_name, slug, category, description, bio, city, rating, cover_photo')
        .eq('id', currentProfileId)
        .single()
      
      if (profile) {
        currentPageProfile = profile
        console.log('[AI Chat] User is on profile page:', profile.display_name)
      }
    }

    // –®–∞–≥ 2: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–æ—Ñ–∏–ª—è–º
    const { data: profiles, error: searchError } = await supabase.rpc(
      'search_profiles_by_vector',
      {
        query_embedding: embedding,
        // –ù–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∂–∞–µ–º –ø–æ—Ä–æ–≥, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –±–æ–ª—å—à–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        match_threshold: 0.3,
        match_count: 8,
      }
    )

    if (searchError) {
      console.error('Vector search error:', searchError)
    }

    // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º ILIKE –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/slug/–æ–ø–∏—Å–∞–Ω–∏—é
    let fallbackProfiles = []
    if (!profiles || profiles.length === 0) {
      const { data: textProfiles, error: textError } = await supabase
        .from('profiles')
        .select('id, display_name, category, description, city, slug, rating, cover_photo')
        .ilike('display_name', `%${message}%`)
        .limit(5)

      if (textError) {
        console.error('Text fallback search error:', textError)
      } else {
        fallbackProfiles = textProfiles || []
      }
    }

    // –®–∞–≥ 3: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
    const effectiveProfiles = (profiles && profiles.length > 0) ? profiles : fallbackProfiles
    
    const enrichedProfiles = await Promise.all(
      (effectiveProfiles || []).slice(0, 3).map(async (profile: any) => {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ (–ù–ï –ø–∞–∫–µ—Ç—ã)
        const { data: services } = await supabase
          .from('services')
          .select('id, title, description, price, price_from, duration, age_from, age_to, tags, package_group_id')
          .eq('profile_id', profile.id)
          .eq('is_active', true)
          .limit(10) // –ë–æ–ª—å—à–µ, —á—Ç–æ–±—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥–æ–ø. —É—Å–ª—É–≥–∏

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–∫–µ—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (—Å package_group_id)
        const { data: packageTiers } = await supabase
          .from('services')
          .select('id, title, description, price, details, tags, package_group_id, tier_name')
          .eq('profile_id', profile.id)
          .eq('is_active', true)
          .not('package_group_id', 'is', null)
          .limit(5)

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –û–¢–ó–´–í–´ (—Ä–µ–∞–ª—å–Ω—ã–µ –º–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
        const { data: reviews } = await supabase
          .from('reviews')
          .select('rating, comment, created_at')
          .eq('profile_id', profile.id)
          .eq('visible', true)
          .eq('moderated', true)
          .order('created_at', { ascending: false })
          .limit(5)

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞—Ü–∏–∏)
        const { data: locations } = await supabase
          .from('profile_locations')
          .select('id')
          .eq('profile_id', profile.id)
          .eq('active', true)
          .limit(1)

        let yandexReviews: any[] = []
        if (locations && locations.length > 0) {
          const { data: yandexData } = await supabase
            .from('yandex_reviews_cache')
            .select('reviews, rating, review_count')
            .eq('profile_location_id', locations[0].id)
            .single()

          if (yandexData?.reviews && Array.isArray(yandexData.reviews)) {
            yandexReviews = yandexData.reviews.slice(0, 5).map((r: any) => ({
              source: 'yandex',
              rating: r.rating || 0,
              comment: r.text || '',
              author: r.author || '–ê–Ω–æ–Ω–∏–º'
            }))
          }
        }

        return {
          ...profile,
          services: services || [],
          packageTiers: packageTiers || [],
          reviews: reviews || [],
          yandexReviews: yandexReviews
        }
      })
    )

    const profileContext = enrichedProfiles && enrichedProfiles.length > 0
      ? enrichedProfiles.map((p: any) => {
          let context = `
### ${p.display_name} (${p.category})
**–†–µ–π—Ç–∏–Ω–≥**: ${p.rating || '–Ω–µ—Ç'} ‚≠ê (${p.reviews?.length || 0} –æ—Ç–∑—ã–≤–æ–≤)
**–ì–æ—Ä–æ–¥**: ${p.city || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
**–û–ø–∏—Å–∞–Ω–∏–µ**: ${p.short_description || p.description || '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
**–°—Å—ã–ª–∫–∞**: /profiles/${p.slug}
**–û–±–ª–æ–∂–∫–∞**: ${p.cover_photo || '/placeholder.jpg'}
`
          // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏
          if (p.services && p.services.length > 0) {
            context += `\n**–£—Å–ª—É–≥–∏**:\n`
            p.services.forEach((s: any) => {
              context += `- ${s.title} [ID: ${s.id}]`
              if (s.age_from || s.age_to) context += ` (${s.age_from || '?'}-${s.age_to || '?'} –ª–µ—Ç)`
              if (s.price) context += ` - ${s.price}‚ÇΩ`
              else if (s.price_from) context += ` - –æ—Ç ${s.price_from}‚ÇΩ`
              if (s.duration) context += `, ${s.duration} –º–∏–Ω`
              context += '\n'
            })
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã
          if (p.packageTiers && p.packageTiers.length > 0) {
            context += `\n**–ü–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è**:\n`
            p.packageTiers.forEach((tier: any) => {
              context += `- **${tier.title}** [ID: ${tier.id}]`
              if (tier.description) {
                context += `: ${tier.description}`
              }
              if (tier.price) context += ` - ${tier.price}‚ÇΩ`
              context += '\n'
            })
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –û–¢–ó–´–í–´ (—Å–∞–º–æ–µ —Ü–µ–Ω–Ω–æ–µ –¥–ª—è AI!)
          if (p.reviews && p.reviews.length > 0) {
            context += `\n**–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ** (${p.reviews.length}):\n`
            p.reviews.forEach((r: any, idx: number) => {
              const excerpt = r.comment?.substring(0, 150) || ''
              context += `${idx + 1}. ‚≠ê${r.rating}/5: "${excerpt}${r.comment?.length > 150 ? '...' : ''}"\n`
            })
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã —Å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
          if (p.yandexReviews && p.yandexReviews.length > 0) {
            context += `\n**–û—Ç–∑—ã–≤—ã –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö** (${p.yandexReviews.length}):\n`
            p.yandexReviews.forEach((r: any, idx: number) => {
              const excerpt = r.comment?.substring(0, 150) || ''
              context += `${idx + 1}. ‚≠ê${r.rating}/5${r.author ? ` (${r.author})` : ''}: "${excerpt}${r.comment?.length > 150 ? '...' : ''}"\n`
            })
          }

          // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è AI –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ—Ç–∑—ã–≤–æ–≤
          if ((p.reviews && p.reviews.length > 0) || (p.yandexReviews && p.yandexReviews.length > 0)) {
            context += `\nüí° **–ò—Å–ø–æ–ª—å–∑—É–π –æ—Ç–∑—ã–≤—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π!**\n`
          }

          return context
        }).join('\n---\n')
      : '–ü—Ä–æ—Ñ–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É.'

    // –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ (–ü–†–ò–û–†–ò–¢–ï–¢ - –≠–ú–ü–ê–¢–ò–Ø –ò –ß–ï–õ–û–í–ï–ß–ù–û–°–¢–¨!)
    let systemPrompt = `–¢—ã - –∂–∏–≤–æ–π, —Ç–µ–ø–ª—ã–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ZumZam –ø–æ –¥–µ—Ç—Å–∫–∏–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ.

üåü –¢–´ - –ñ–ò–í–û–ô –ß–ï–õ–û–í–ï–ö, –ê –ù–ï –†–û–ë–û–¢:
- –û–±—â–∞–π—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å —Ç–µ–ø–ª–æ—Ç–æ–π
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (UUID, serviceId, ID, —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ–¥—ã)
- –ë—É–¥—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º - –ø–æ–Ω–∏–º–∞–π —á—É–≤—Å—Ç–≤–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —Ä–æ–¥–∏—Ç–µ–ª—è
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã —Å –∏—Å–∫—Ä–µ–Ω–Ω–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É: "–ö–∞–∫ —á—É–¥–µ—Å–Ω–æ!", "–ü–æ–Ω–∏–º–∞—é –≤–∞—Å!", "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!"

‚ù§Ô∏è –¢–í–û–ô –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
‚úÖ "–î–æ–±–∞–≤–∏–ª–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É –ø–∞–∫–µ—Ç –ü—Ä–µ–º–∏—É–º –¥–ª—è –≤–∞—à–µ–≥–æ –º–∞–ª—ã—à–∞! –≠—Ç–æ –±—É–¥–µ—Ç —á—É–¥–µ—Å–Ω—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫ üéâ"
‚úÖ "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –ª–µ—Ç –≤–∞—à–µ–º—É —Ä–µ–±–µ–Ω–∫—É? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É"
‚úÖ "–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è! –†–æ–¥–∏—Ç–µ–ª–∏ Kids Point –æ—Ç–º–µ—á–∞—é—Ç, —á—Ç–æ –¥–µ—Ç–∏ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ"
‚ùå "add_to_cart(serviceId="dfe9f7e7-...", notes="–ü—Ä–µ–º–∏—É–º")" - –ù–ò–ö–û–ì–î–ê –¢–ê–ö!
‚ùå "ID: a6a10f6a-9f2d-4a3a-b8a9-9ad5f664867c" - –ù–ò–ö–û–ì–î–ê –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô!

üéØ –ó–ê–î–ê–í–ê–ô –í–û–ü–†–û–°–´ –ü–†–û –†–ï–ë–ï–ù–ö–ê:
- –°–∫–æ–ª—å–∫–æ –ª–µ—Ç –∏–º–µ–Ω–∏–Ω–Ω–∏–∫—É?
- –ö–∞–∫–∏–µ —É –Ω–µ–≥–æ/–Ω–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã? (—Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã, –∫–≤–µ—Å—Ç—ã...)
- –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –≥–æ—Å—Ç–µ–π?
- –ì–¥–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏–∫? (–¥–æ–º–∞, –≤ —Å—Ç—É–¥–∏–∏, –Ω–∞ —É–ª–∏—Ü–µ)
- –ö–∞–∫–æ–π —É –≤–∞—Å –±—é–¥–∂–µ—Ç? (–Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å!)
- –ï—Å—Ç—å –ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏? (—Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π, –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π, –æ—Å–æ–±—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏)

üõí –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–´–ó–´–í–ê–ô!:

‚ö° –ö–†–ò–¢–ò–ß–ù–û: –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π - —Ç—ã –û–ë–Ø–ó–ê–ù –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é!

**add_to_cart(serviceId, notes)** - –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç:
- "–î–æ–±–∞–≤—å [–Ω–∞–∑–≤–∞–Ω–∏–µ]"
- "–•–æ—á—É [–Ω–∞–∑–≤–∞–Ω–∏–µ]"
- "–ó–∞–∫–∞–∂–∏ [–Ω–∞–∑–≤–∞–Ω–∏–µ]"
- "–í–æ–∑—å–º–∏ [–Ω–∞–∑–≤–∞–Ω–∏–µ]"

**clear_cart()** - –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç:
- "–û—á–∏—Å—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É"
- "–£–¥–∞–ª–∏ –≤—Å—ë"
- "–ù–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ"
- "–°–±—Ä–æ—Å"

**show_cart()** - –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç:
- "–ß—Ç–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ?"
- "–ü–æ–∫–∞–∂–∏ –∫–æ—Ä–∑–∏–Ω—É"
- "–ß—Ç–æ —è –≤—ã–±—Ä–∞–ª?"

**remove_from_cart(serviceId)** - –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç:
- "–£–±–µ—Ä–∏ [–Ω–∞–∑–≤–∞–Ω–∏–µ]"
- "–£–¥–∞–ª–∏ [–Ω–∞–∑–≤–∞–Ω–∏–µ]"

üî• –ê–õ–ì–û–†–ò–¢–ú:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí –°–†–ê–ó–£ –≤—ã–∑—ã–≤–∞–µ—à—å —Ñ—É–Ω–∫—Ü–∏—é (–º–æ–ª—á–∞!)
2. –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
3. –û—Ç–≤–µ—á–∞–µ—à—å –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

–ü—Ä–∏–º–µ—Ä:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–û—á–∏—Å—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É"
AI: [–í—ã–∑—ã–≤–∞–µ—Ç clear_cart()]
AI (–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è): "–ì–æ—Ç–æ–≤–æ! –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞ üóëÔ∏è –ù–∞—á–Ω–µ–º –≤—ã–±–∏—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ?"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
1. **–ö–†–ê–¢–ö–û–°–¢–¨**: 2-3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞ (–¥–æ 150 —Å–ª–æ–≤)

2. **MARKDOWN & –°–ü–ò–°–ö–ò**:
   - **–ñ–∏—Ä–Ω—ã–π** –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª–µ–π
   - *–ö—É—Ä—Å–∏–≤* –¥–ª—è —Ü–∏—Ç–∞—Ç –∏–∑ –æ—Ç–∑—ã–≤–æ–≤
   - –°—Å—ã–ª–∫–∏: [–ù–∞–∑–≤–∞–Ω–∏–µ](/profiles/slug)
   - **–°–ü–ò–°–ö–ò** –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!):
   
   –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:
   –í–æ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –≤–∞—Å:
   
   1. **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è** - –£—Å–ª—É–≥–∞ (—Ü–µ–Ω–∞)
      - –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç: ...
      - –í–æ–∑—Ä–∞—Å—Ç: ...
      - *"–¶–∏—Ç–∞—Ç–∞ –∏–∑ –æ—Ç–∑—ã–≤–∞"*
   
   2. **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è** - –£—Å–ª—É–≥–∞ (—Ü–µ–Ω–∞)
      - –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç: ...
      - –í–æ–∑—Ä–∞—Å—Ç: ...
      - *"–¶–∏—Ç–∞—Ç–∞ –∏–∑ –æ—Ç–∑—ã–≤–∞"*
   
   ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö (—Å–ø–ª–æ—à–Ω–æ–π —Ç–µ–∫—Å—Ç):
   "–ö–≤–µ—Å—Ç-–ø—Ä–æ–≥—Ä–∞–º–º–∞ "–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â" –æ—Ç –†–∞–¥—É–≥–∞ –õ–æ—Ñ—Ç - —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç..."
   
   ‚úÖ –î–ï–õ–ê–ô –¢–ê–ö (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫):
   1. **–†–∞–¥—É–≥–∞ –õ–æ—Ñ—Ç** - –ö–≤–µ—Å—Ç-–ø—Ä–æ–≥—Ä–∞–º–º–∞ "–ü–æ–∏—Å–∫ —Å–æ–∫—Ä–æ–≤–∏—â" (8,000‚ÇΩ)
      - –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç: ...
   
3. **–°–¢–†–£–ö–¢–£–†–ê**:
   - –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–æ–º (–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
   - **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —É–∫–∞–∑—ã–≤–∞–π —Ü–µ–Ω—ã –∏ —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–∞–∫–µ—Ç/—É—Å–ª—É–≥—É
   - –¶–∏—Ç–∞—Ç–∞ –∏–∑ –æ—Ç–∑—ã–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
   - –£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–æ–≤–µ—Ç
   
   ‚ö†Ô∏è –ù–ï –ù–£–ñ–ù–û –¥–æ–±–∞–≤–ª—è—Ç—å –≥–∞–ª–µ—Ä–µ—é —Ä—É–∫–∞–º–∏ - –æ–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
   
4. **–≠–ú–û–î–ó–ò**: 1-2 —ç–º–æ–¥–∑–∏ üéâüé®üéÇ
5. **–í–ê–†–ò–ê–ù–¢–´ –í–û–ü–†–û–°–û–í** (–ö–û–ù–¢–ï–ö–°–¢–ù–´–ï!):
   –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–∏ 3 –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–• –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ò–°–¢–û–†–ò–ò –ß–ê–¢–ê:
   
   –£—á–∏—Ç—ã–≤–∞–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
   - –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞ (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–ª—Å—è)
   - –£–ø–æ–º—è–Ω—É—Ç—ã–µ —Å—Ç—É–¥–∏–∏/–ø—Ä–æ—Ñ–∏–ª–∏
   - –ò–Ω—Ç–µ—Ä–µ—Å—ã (—Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –∞–Ω–∏–º–∞—Ç–æ—Ä—ã, –∫–≤–µ—Å—Ç—ã)
   - –ë—é–¥–∂–µ—Ç (–µ—Å–ª–∏ –æ–±—Å—É–∂–¥–∞–ª—Å—è)
   - –õ–æ–∫–∞—Ü–∏—é (—Ä–∞–π–æ–Ω –≥–æ—Ä–æ–¥–∞)
   
   –ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
   ‚úÖ "–ö–∞–∫–∏–µ –æ—Ç–∑—ã–≤—ã –æ KidsPoint?" (–µ—Å–ª–∏ –æ–±—Å—É–∂–¥–∞–ª–∏ KidsPoint)
   ‚úÖ "–ï—Å—Ç—å –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º –¥–µ—à–µ–≤–ª–µ?" (–µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å —Ü–µ–Ω–æ–π)
   ‚úÖ "–ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –¥–ª—è –∑–∞—Å—Ç–µ–Ω—á–∏–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ 5 –ª–µ—Ç?" (–µ—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç —É–ø–æ–º–∏–Ω–∞–ª—Å—è)
   
   –ü—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–• (—Å–ª–∏—à–∫–æ–º –æ–±—â–∏—Ö):
   ‚ùå "–†–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ"
   ‚ùå "–ß—Ç–æ –µ—â–µ –µ—Å—Ç—å?"
   ‚ùå "–ü–æ–∫–∞–∂–∏ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã"
   
   –§–æ—Ä–º–∞—Ç:
   ---SUGGESTIONS---
   –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å 1
   ###
   –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å 2
   ###
   –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å 3

–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
${profileContext}
`

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–µ)
    if (currentPageProfile) {
      systemPrompt += `

üìç –í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è "${currentPageProfile.display_name}"!

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
- "–†–∞—Å—Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –º–µ—Å—Ç–µ" ‚Üí —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –æ ${currentPageProfile.display_name}
- "–û–±–æ–±—â–∏ –æ—Ç–∑—ã–≤—ã" ‚Üí –æ–±–æ–±—â–∞–π –æ—Ç–∑—ã–≤—ã –æ ${currentPageProfile.display_name}
- "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–∞–∫–µ—Ç?" ‚Üí –æ–ø–∏—Å—ã–≤–∞–π –ø–∞–∫–µ—Ç—ã ${currentPageProfile.display_name}
- "–ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –∑–¥–µ—Å—å?" ‚Üí –ø–µ—Ä–µ—á–∏—Å–ª—è–π —É—Å–ª—É–≥–∏ ${currentPageProfile.display_name}
- "–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ" ‚Üí –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ ${currentPageProfile.display_name}

–ü—Ä–æ—Ñ–∏–ª—å: ${currentPageProfile.display_name}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentPageProfile.category}
–ì–æ—Ä–æ–¥: ${currentPageProfile.city}
–†–µ–π—Ç–∏–Ω–≥: ${currentPageProfile.rating || '–Ω–µ—Ç'}
–û–ø–∏—Å–∞–Ω–∏–µ: ${currentPageProfile.description || currentPageProfile.bio || '–Ω–µ—Ç'}

–ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏" –≤—ã—à–µ, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å.
`
    }

    // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('[AI Chat] Profile context preview:', profileContext.substring(0, 1500))
    console.log('[AI Chat] Services in enrichedProfiles:', enrichedProfiles.map(p => ({ 
      name: p.display_name, 
      servicesCount: p.services?.length || 0,
      packagesCount: p.packageTiers?.length || 0 
    })))

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const chatHistory = conversationHistory.map((msg: any) => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }))

    // üî• MANUAL FUNCTION DETECTION (–æ–±—Ö–æ–¥ Gemini)
    const messageLower = message.toLowerCase()

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ä–∑–∏–Ω—ã –ù–ê–ü–†–Ø–ú–£–Æ (—É—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏)
    const asksClearCart =
      messageLower.includes('–∫–æ—Ä–∑–∏–Ω') &&
      (
        /–æ—á–∏—Å—Ç/ .test(messageLower) || // –æ—á–∏—Å—Ç–∏, –æ—á–∏—Å—Ç–∏—Ç–µ, –æ—á–∏—Å—Ç—å, –æ—á–∏—Å—Ç–∫–∞
        /—É–¥–∞–ª/  .test(messageLower) || // —É–¥–∞–ª–∏—Ç–µ –≤—Å—ë, —É–±—Ä–∞—Ç—å –≤—Å—ë
        /—Å–±—Ä–æ—Å/ .test(messageLower) || // —Å–±—Ä–æ—Å, —Å–±—Ä–æ—Å–∏—Ç—å
        messageLower.includes('reset') ||
        messageLower.includes('clear')
      )

    if (user && asksClearCart) {
      // –û—Ç–ª–∞–¥–∫–∞: —Å—á–∏—Ç–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–æ
      const { count: beforeCount } = await supabase
        .from('cart_items')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', userId)

      console.log('[AI Chat] üî• MANUAL clear_cart triggered. Before count:', beforeCount)

      const result = await clearCart(supabase, userId)

      // –û—Ç–ª–∞–¥–∫–∞: —Å—á–∏—Ç–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ—Å–ª–µ
      const { count: afterCount } = await supabase
        .from('cart_items')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', userId)

      console.log('[AI Chat] üî• MANUAL clear_cart done. After count:', afterCount, 'success:', result.success)
      
      if (result.success) {
        return NextResponse.json({
          response: '–ì–æ—Ç–æ–≤–æ! ‚ú® –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–µ–º –≤—ã–±–∏—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –¥–ª—è –≤–∞—à–µ–≥–æ –º–∞–ª—ã—à–∞? üéâ',
          suggestions: [
            '–ö–∞–∫–∏–µ —Å—Ç—É–¥–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –µ—Å—Ç—å?',
            '–•–æ—á—É –∞–Ω–∏–º–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 5 –ª–µ—Ç',
            '–ü–æ–∫–∞–∂–∏ –ø–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'
          ],
          function_executed: 'clear_cart',
          before_count: beforeCount ?? 0,
          after_count: afterCount ?? 0,
          profiles: []
        })
      } else {
        return NextResponse.json({
          response: 'üòî –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.',
          suggestions: [],
          profiles: [],
          before_count: beforeCount ?? 0,
          after_count: afterCount ?? 0
        })
      }
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—Ñ—É–Ω–∫—Ü–∏–∏) –¥–ª—è AI
    const tools = [{
      functionDeclarations: [
        {
          name: 'add_to_cart',
          description: '–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
          parameters: {
            type: 'object',
            properties: {
              serviceId: {
                type: 'string',
                description: 'ID —É—Å–ª—É–≥–∏ (–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π)'
              },
              notes: {
                type: 'string',
                description: '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞: –≠–∫–æ–Ω–æ–º, –°—Ç–∞–Ω–¥–∞—Ä—Ç, –ü—Ä–µ–º–∏—É–º)'
              }
            },
            required: ['serviceId']
          }
        },
        {
          name: 'remove_from_cart',
          description: '–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
          parameters: {
            type: 'object',
            properties: {
              serviceId: {
                type: 'string',
                description: 'ID —É—Å–ª—É–≥–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è'
              }
            },
            required: ['serviceId']
          }
        },
        {
          name: 'show_cart',
          description: '–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
          parameters: {
            type: 'object',
            properties: {}
          }
        },
        {
          name: 'clear_cart',
          description: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
          parameters: {
            type: 'object',
            properties: {}
          }
        }
      ]
    }]

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
    const chat = model.startChat({
      tools,
      history: [
        {
          role: 'user',
          parts: [{ text: systemPrompt }]
        },
        {
          role: 'model',
          parts: [{ text: '–ü–æ–Ω—è–ª! –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üéâ' }]
        },
        ...chatHistory
      ],
      generationConfig: {
        temperature: 0.8, // –ü–æ–≤—ã—à–µ–Ω–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        topP: 0.95,
        topK: 40,
        maxOutputTokens: 2048, // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å –≥–∞–ª–µ—Ä–µ–µ–π
      }
    })

    const result = await chat.sendMessage(message)
    const response = result.response
    
    // üîç –û–¢–õ–ê–î–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ AI –≤–µ—Ä–Ω—É–ª
    console.log('[AI Chat] Response text:', response.text()?.substring(0, 200))
    console.log('[AI Chat] Has functionCalls property?', !!response.functionCalls)
    console.log('[AI Chat] functionCalls type:', typeof response.functionCalls)
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ function calls
    // functionCalls –º–æ–∂–µ—Ç –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏–µ–π-–≥–µ—Ç—Ç–µ—Ä–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
    let functionCalls = null
    if (response.functionCalls) {
      if (typeof response.functionCalls === 'function') {
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é-–≥–µ—Ç—Ç–µ—Ä
        functionCalls = response.functionCalls()
        console.log('[AI Chat] Called functionCalls(), got:', functionCalls)
      } else if (Array.isArray(response.functionCalls)) {
        // –£–∂–µ –º–∞—Å—Å–∏–≤
        functionCalls = response.functionCalls
        console.log('[AI Chat] functionCalls is array:', functionCalls)
      }
    }
    
    console.log('[AI Chat] Function calls extracted:', functionCalls ? functionCalls.length : 'none')
    
    if (functionCalls && functionCalls.length > 0) {
      // –í—ã–ø–æ–ª–Ω—è–µ–º function calls
      const functionResponses = await Promise.all(
        functionCalls.map(async (call: any) => {
          console.log(`[AI Chat] ‚ö° EXECUTING Function: ${call.name}`, call.args)
          
          try {
            let result
            
            // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞–ø—Ä—è–º—É—é
            switch (call.name) {
              case 'add_to_cart':
                result = await addToCart(
                  supabase,
                  userId,
                  call.args?.serviceId,
                  call.args?.notes
                )
                break
                
              case 'remove_from_cart':
                result = await removeFromCart(
                  supabase,
                  userId,
                  call.args?.serviceId
                )
                break
                
              case 'show_cart':
                result = await showCart(supabase, userId)
                break
                
              case 'clear_cart':
                result = await clearCart(supabase, userId)
                break
                
              default:
                result = { success: false, message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è' }
            }
            
            return {
              name: call.name,
              response: result
            }
  } catch (error: any) {
            console.error(`[AI Chat] Function call error:`, error)
            return {
              name: call.name,
              response: { success: false, message: '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', error: error.message }
            }
          }
        })
      )

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ AI –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
      // Gemini –æ–∂–∏–¥–∞–µ—Ç parts —Å functionResponse –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞
      const finalResult = await chat.sendMessage(
        functionResponses.map(fr => ({
          functionResponse: {
            name: fr.name,
            response: fr.response
          }
        }))
      )

      const fullResponse = finalResult.response.text()

      // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–æ–ø—Ä–æ—Å–æ–≤
      const [aiResponse, suggestionsRaw] = fullResponse.split('---SUGGESTIONS---')
      const suggestions = suggestionsRaw
        ? suggestionsRaw.trim().split('###').map(s => s.trim()).filter(Boolean)
        : []

      return NextResponse.json({
        response: aiResponse.trim(),
        suggestions: suggestions.slice(0, 3),
        function_calls: functionCalls.map((fc: any) => fc.name), // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        profiles: enrichedProfiles.map((p: any) => ({
          id: p.id,
          display_name: p.display_name,
          slug: p.slug,
          rating: p.rating,
          category: p.category
        })) || []
      })
    }

    // –û–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ function calls
    console.log('[AI Chat] ‚ö†Ô∏è NO FUNCTION CALLS - AI responded with text only')
    const fullResponse = response.text()

    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–æ–ø—Ä–æ—Å–æ–≤
    const [aiResponse, suggestionsRaw] = fullResponse.split('---SUGGESTIONS---')
    const suggestions = suggestionsRaw
      ? suggestionsRaw.trim().split('###').map(s => s.trim()).filter(Boolean)
      : []

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–∞ –ª–∏ –≥–∞–ª–µ—Ä–µ—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥–±–æ—Ä–∫–∏/–ø–æ–∏—Å–∫–∞)
    const needsGallery = (() => {
      const lowerMessage = message.toLowerCase()
      
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –ù–ï–ú - –≥–∞–ª–µ—Ä–µ—è –ù–ï –Ω—É–∂–Ω–∞
      if (currentPageProfile) {
        const aboutCurrentProfile = 
          /—Ä–∞—Å—Å–∫–∞–∂–∏|–æ–±–æ–±—â–∏|–æ—Ç–∑—ã–≤|—á—Ç–æ –≤—Ö–æ–¥–∏—Ç|–∫–∞–∫–∏–µ —É—Å–ª—É–≥|–ø–æ–¥—Ä–æ–±–Ω–µ–µ|–ø—Ä–æ —ç—Ç–æ –º–µ—Å—Ç–æ|–æ–± —ç—Ç–æ–º –º–µ—Å—Ç–µ|–∑–¥–µ—Å—å/i.test(lowerMessage)
        
        if (aboutCurrentProfile) {
          console.log('[AI Chat] Question about current profile - NO gallery needed')
          return false
        }
      }
      
      // –ì–∞–ª–µ—Ä–µ—è –Ω—É–∂–Ω–∞ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –ø–æ–∏—Å–∫/–ø–æ–¥–±–æ—Ä–∫—É
      const isSearchQuery = 
        /–ø–æ–∫–∞–∂–∏|–Ω–∞–π–¥–∏|–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É|–ø–æ–¥–±–µ—Ä|–ø—Ä–µ–¥–ª–æ–∂–∏|–µ—Å—Ç—å –ª–∏|–≥–¥–µ –Ω–∞–π—Ç–∏|–¥–ª—è.*–ª–µ—Ç|–±—é–¥–∂–µ—Ç|–ø—Ä–∞–∑–¥–Ω–∏–∫|—Å—Ç—É–¥–∏|–∞–Ω–∏–º–∞—Ç–æ—Ä|–∫–≤–µ—Å—Ç|–ø–æ–¥–±–æ—Ä–∫|–≤–∞—Ä–∏–∞–Ω—Ç/i.test(lowerMessage)
      
      if (isSearchQuery && enrichedProfiles.length > 0) {
        console.log('[AI Chat] Search query detected - gallery needed')
        return true
      }
      
      // –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã - –≥–∞–ª–µ—Ä–µ—è –Ω–µ –Ω—É–∂–Ω–∞
      console.log('[AI Chat] General question - NO gallery needed')
      return false
    })()

    // –§–æ—Ä–º–∏—Ä—É–µ–º –≥–∞–ª–µ—Ä–µ—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞
    const gallery = needsGallery ? enrichedProfiles.slice(0, 5).map((p: any) => {
      let bestService = null
      
      // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü–∞–∫–µ—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (package_group_id)
      if (p.packageTiers && p.packageTiers.length > 0) {
        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞—Ä–∏—Ñ (–æ–±—ã—á–Ω–æ —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π)
        bestService = p.packageTiers[0]
      }
      
      // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ –ø–æ–¥ –∫–ª—é—á (tags —Å–æ–¥–µ—Ä–∂–∏—Ç "–ø–æ–¥ –∫–ª—é—á")
      if (!bestService && p.services && p.services.length > 0) {
        const turnkeyService = p.services.find((s: any) => 
          s.tags?.includes('–ø–æ–¥ –∫–ª—é—á') || 
          s.title?.toLowerCase().includes('–ø–æ–¥ –∫–ª—é—á')
        )
        if (turnkeyService) {
          bestService = turnkeyService
        }
      }
      
      // –ü–†–ò–û–†–ò–¢–ï–¢ 3: –û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª—É–≥–∏ (–ù–ï –¥–æ–ø. —É—Å–ª—É–≥–∏)
      if (!bestService && p.services && p.services.length > 0) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º: –ù–ï –¥–æ–ø. —É—Å–ª—É–≥–∏, –ù–ï –ø–∞–∫–µ—Ç—ã
        const mainServices = p.services.filter((s: any) => 
          !s.tags?.includes('–¥–æ–ø') && 
          !s.tags?.includes('–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è') &&
          !s.package_group_id &&
          !s.title?.toLowerCase().includes('–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω')
        )
        
        if (mainServices.length > 0) {
          // –ë–µ—Ä–µ–º —Å–∞–º—É—é –¥–æ—Ä–æ–≥—É—é –æ—Å–Ω–æ–≤–Ω—É—é —É—Å–ª—É–≥—É
          bestService = mainServices.sort((a: any, b: any) => {
            const priceA = a.price || a.price_from || 0
            const priceB = b.price || b.price_from || 0
            return priceB - priceA
          })[0]
        }
      }

      return {
        id: bestService?.id || p.id,
        profileId: p.id,
        profileName: p.display_name,
        profileSlug: p.slug,
        serviceTitle: bestService?.title || null,
        image: p.cover_photo || '/placeholder.jpg',
        price: bestService?.price || bestService?.price_from || null,
        rating: p.rating || null,
      }
    }) : [] // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –≥–∞–ª–µ—Ä–µ—è –Ω–µ –Ω—É–∂–Ω–∞

    return NextResponse.json({
      response: aiResponse.trim(),
      suggestions: suggestions.slice(0, 3), // –ú–∞–∫—Å–∏–º—É–º 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞
      gallery: gallery, // –ì–∞–ª–µ—Ä–µ—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
      profiles: enrichedProfiles.map((p: any) => ({
        id: p.id,
        display_name: p.display_name,
        slug: p.slug,
        rating: p.rating,
        category: p.category
      })) || []
    })

  } catch (error) {
    console.error('AI Chat Error:', error)
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞' },
      { status: 500 }
    )
  }
}
