/**
 * API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–∫–∞–∑–æ–º
 * GET /api/orders/[id] - –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ ID
 * PATCH /api/orders/[id] - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫)
 */

import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'
import type { OrderStatus } from '@/types'

interface RouteParams {
  params: Promise<{ id: string }>
}

/**
 * GET /api/orders/[id] - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ ID
 */
export async function GET(request: Request, { params }: RouteParams) {
  try {
    const { id } = await params
    const supabase = await createClient()
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    const { data: order, error } = await supabase
      .from('orders')
      .select(`
        *,
        items:order_items (*),
        profile:profiles (
          id,
          display_name,
          slug,
          city,
          phone,
          email,
          logo,
          main_photo,
          custom_fields_config
        )
      `)
      .eq('id', id)
      .single()

    if (error) {
      console.error('[Order API] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error)
      if (error.code === 'PGRST116') {
        return NextResponse.json({ error: 'Order not found' }, { status: 404 })
      }
      throw error
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫)
    if (order.client_id !== user.id && order.provider_id !== user.id) {
      return NextResponse.json({ error: 'Access denied' }, { status: 403 })
    }

    return NextResponse.json({ order })
  } catch (error: any) {
    console.error('[Order API] GET error:', error)
    return NextResponse.json(
      { error: error.message || 'Failed to fetch order' },
      { status: 500 }
    )
  }
}

/**
 * PATCH /api/orders/[id] - –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑
 */
export async function PATCH(request: Request, { params }: RouteParams) {
  try {
    const { id } = await params
    const supabase = await createClient()
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body = await request.json()
    const { 
      status, 
      provider_response,
      provider_internal_notes,
      pipeline_stage_id,
      event_date,
      event_time,
      event_address,
      child_age,
      children_count,
      client_name,
      client_phone,
      client_email,
      items,
      discount,
      discount_type,
      total_amount,
      custom_fields,
      title
    } = body

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
    const { data: currentOrder, error: fetchError } = await supabase
      .from('orders')
      .select('id, client_id, provider_id, status')
      .eq('id', id)
      .single()

    if (fetchError || !currentOrder) {
      return NextResponse.json({ error: 'Order not found' }, { status: 404 })
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const isProvider = currentOrder.provider_id === user.id
    const isClient = currentOrder.client_id === user.id

    if (!isProvider && !isClient) {
      return NextResponse.json({ error: 'Access denied' }, { status: 403 })
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const updateData: any = {
      updated_at: new Date().toISOString(),
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const oldStatus = currentOrder.status
    let statusChanged = false

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    if (isProvider) {
      if (status) {
        updateData.status = status
        statusChanged = status !== oldStatus
        if (status === 'confirmed') updateData.confirmed_at = new Date().toISOString()
        else if (status === 'completed') updateData.completed_at = new Date().toISOString()
        else if (status === 'cancelled' || status === 'rejected') updateData.cancelled_at = new Date().toISOString()
      }
      
      if (provider_response !== undefined) {
        updateData.provider_response = provider_response
        updateData.provider_response_at = new Date().toISOString()
      }
      
      if (provider_internal_notes !== undefined) updateData.provider_internal_notes = provider_internal_notes
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pipeline_stage_id –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è status
      if (pipeline_stage_id !== undefined) {
        updateData.pipeline_stage_id = pipeline_stage_id
        
        // –ü–æ–ª—É—á–∞–µ–º system_status —ç—Ç–∞–ø–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º order.status
        const { data: stage } = await supabase
          .from('pipeline_stages')
          .select('system_status')
          .eq('id', pipeline_stage_id)
          .single()
        
        if (stage?.system_status) {
          updateData.status = stage.system_status
          statusChanged = stage.system_status !== oldStatus
          // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
          if (stage.system_status === 'confirmed') updateData.confirmed_at = new Date().toISOString()
          else if (stage.system_status === 'completed') updateData.completed_at = new Date().toISOString()
          else if (stage.system_status === 'cancelled' || stage.system_status === 'rejected') updateData.cancelled_at = new Date().toISOString()
        }
      }
      
      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏
      if (event_date !== undefined) updateData.event_date = event_date
      if (event_time !== undefined) updateData.event_time = event_time
      if (event_address !== undefined) updateData.event_address = event_address
      if (child_age !== undefined) updateData.child_age = child_age
      if (children_count !== undefined) updateData.children_count = children_count
      
      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
      if (client_name !== undefined) updateData.client_name = client_name
      if (client_phone !== undefined) updateData.client_phone = client_phone
      if (client_email !== undefined) updateData.client_email = client_email

      // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–ª—è
      if (discount !== undefined) updateData.discount = discount
      if (discount_type !== undefined) updateData.discount_type = discount_type
      if (total_amount !== undefined) updateData.total_amount = total_amount
      
      // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
      if (title !== undefined) updateData.title = title
      
      // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è
      if (custom_fields !== undefined) updateData.custom_fields = custom_fields

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –∑–∞–∫–∞–∑–∞ (items)
      if (items && Array.isArray(items)) {
        const requestId = Math.random().toString(36).substring(7)
        console.log(`[Order API ${requestId}] Updating items for order:`, id, 'count:', items.length)
        
        // 1. –í–°–ï–ì–î–ê —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (–¥–∞–∂–µ –µ—Å–ª–∏ items –ø—É—Å—Ç–æ–π)
        const { error: deleteError } = await supabase.from('order_items').delete().eq('order_id', id)
        if (deleteError) {
          console.error(`[Order API ${requestId}] Delete items error:`, deleteError)
          return NextResponse.json({ error: 'Failed to delete old items' }, { status: 500 })
        }
        console.log(`[Order API ${requestId}] Deleted old items`)
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
        if (items.length > 0) {
          const newItems = items.map((item: any) => {
            const price = Number(item.price) || 0
            const quantity = Number(item.quantity) || 1
            return {
              order_id: id,
              service_id: item.service_id || null,
              service_title: item.service_title,
              price,
              quantity,
              subtotal: price * quantity,
              service_description: item.service_description
            }
          })
          
          const { error: itemsError } = await supabase.from('order_items').insert(newItems)
          if (itemsError) {
            console.error(`[Order API ${requestId}] Insert items error:`, itemsError)
            return NextResponse.json({ error: 'Failed to insert items' }, { status: 500 })
          }
          
          console.log(`[Order API ${requestId}] Inserted ${newItems.length} items successfully`)
        }
      }

    } 
    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –ø—Ä–æ–≤–∞–π–¥–µ—Ä)
    else if (isClient && status) {
      if (status === 'cancelled' && currentOrder.status === 'pending') {
        updateData.status = 'cancelled'
        updateData.cancelled_at = new Date().toISOString()
      } else {
        return NextResponse.json(
          { error: 'Clients can only cancel pending orders' },
          { status: 403 }
        )
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑
    const { data: updatedOrder, error: updateError } = await supabase
      .from('orders')
      .update(updateData)
      .eq('id', id)
      .select(`
        *,
        items:order_items (*),
        profile:profiles (
          id,
          display_name,
          slug,
          city,
          phone,
          email,
          logo,
          main_photo,
          custom_fields_config
        ),
        pipeline_stage:pipeline_stages (
          id,
          name,
          color,
          system_status
        )
      `)
      .single()

    if (updateError) {
      console.error('[Order API] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', updateError)
      throw updateError
    }

    // –°–æ–∑–¥–∞—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è)
    if (isProvider && statusChanged && updatedOrder.status) {
      const statusMessages: Record<string, { title: string; body: string }> = {
        confirmed: {
          title: '–ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! üéâ',
          body: `–í–∞—à –∑–∞–∫–∞–∑ ‚Ññ${updatedOrder.order_number || updatedOrder.id.slice(0, 8)} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∏ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.`,
        },
        in_progress: {
          title: '–ó–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç–µ',
          body: `–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –∑–∞–∫–∞–∑–æ–º ‚Ññ${updatedOrder.order_number || updatedOrder.id.slice(0, 8)} –Ω–∞—á–∞–ª–∞—Å—å.`,
        },
        completed: {
          title: '–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ',
          body: `–ó–∞–∫–∞–∑ ‚Ññ${updatedOrder.order_number || updatedOrder.id.slice(0, 8)} —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!`,
        },
        cancelled: {
          title: '–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω',
          body: `–ó–∞–∫–∞–∑ ‚Ññ${updatedOrder.order_number || updatedOrder.id.slice(0, 8)} –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω.`,
        },
        rejected: {
          title: '–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω—ë–Ω',
          body: `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞–∫–∞–∑ ‚Ññ${updatedOrder.order_number || updatedOrder.id.slice(0, 8)} –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω.`,
        },
      }

      const message = statusMessages[updatedOrder.status]
      if (message) {
        await supabase.from('notifications').insert({
          user_id: currentOrder.client_id,
          type: `order_${updatedOrder.status}`,
          title: message.title,
          body: message.body,
          action_url: `/orders?id=${id}`,
          read: false,
          read_at: null,
          data: {
            order_id: id,
            order_number: updatedOrder.order_number,
            status: updatedOrder.status,
          },
        })
      }
    }

    return NextResponse.json({
      order: updatedOrder,
      message: 'Order updated successfully',
    })
  } catch (error: any) {
    console.error('[Order API] PATCH error:', error)
    return NextResponse.json(
      { error: error.message || 'Failed to update order' },
      { status: 500 }
    )
  }
}
