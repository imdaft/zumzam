# ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Supabase client –≤ wizard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

## ‚úÖ UPDATE (–∞–∫—Ç—É–∞–ª—å–Ω–æ)

–°–µ–π—á–∞—Å —Ñ–∏–∫—Å —Å–¥–µ–ª–∞–Ω **–±–µ–∑ API‚Äë–∫–æ—Å—Ç—ã–ª–µ–π**:

- `lib/supabase/client.ts`: **singleton** ‚Äî –æ–¥–∏–Ω Supabase browser client –Ω–∞ –≤–∫–ª–∞–¥–∫—É (—Ä–∞–Ω—å—à–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –¥–µ—Å—è—Ç–∫–∏ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤, —á—Ç–æ –∏ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ ‚Äú–≤–µ—á–Ω–æ–º—É pending‚Äù –≤ wizard).
- `step-2-activities.tsx`: –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ Supabase + **—Ç–∞–π–º–∞—É—Ç** (—á—Ç–æ–±—ã —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º).
- `step-3-services.tsx`: `useQuery` + –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ Supabase + **—Ç–∞–π–º–∞—É—Ç** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ).
- `app/api/activity-catalog/*` –∏ `app/api/test-activity-catalog/*`: **—É–¥–∞–ª–µ–Ω—ã** (–±—ã–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏).

–ù–∏–∂–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –º–æ–∂–µ—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–µ–º–æ–∏–∑–∞—Ü–∏—è + –∑–∞–¥–µ—Ä–∂–∫–∏). –û—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –∫–æ–¥ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ `docs/SUPABASE_CLIENT_ISSUE.md` (—Ç–∞–º –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è UPDATE).

## üîß **–ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û**

### **–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä—è–º–æ–π client-side Supabase –∑–∞–ø—Ä–æ—Å –≤ `step-2-activities.tsx` (–≤–Ω—É—Ç—Ä–∏ wizard) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª HTTP-–∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–º–∏—Å –∑–∞–≤–∏—Å–∞–ª –Ω–∞–≤—Å–µ–≥–¥–∞.

### **–†–µ—à–µ–Ω–∏–µ:**
1. **–ú–µ–º–æ–∏–∑–∞—Ü–∏—è Supabase client** —á–µ—Ä–µ–∑ `useMemo`
2. **–Ø–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è auth session** –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (`await supabase.auth.getSession()`)
3. **–ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

---

## üìù **–ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï**

### **`components/features/profile/wizard/step-2-activities.tsx`**

**–î–æ (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ):**
```tsx
useEffect(() => {
  async function loadActivities() {
    const supabase = createClient() // –°–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
    const { data } = await supabase
      .from('activity_catalog')
      .select('...')
    // ‚ùå –ü—Ä–æ–º–∏—Å –∑–∞–≤–∏—Å–∞–µ—Ç, HTTP-–∑–∞–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
  }
  loadActivities()
}, [])
```

**–ü–æ—Å–ª–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç):**
```tsx
// –ú–µ–º–æ–∏–∑–∏—Ä—É–µ–º Supabase client –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
const supabase = useMemo(() => createClient(), [])
const initializedRef = useRef(false)

useEffect(() => {
  if (initializedRef.current) return
  initializedRef.current = true
  
  let cancelled = false
  
  async function loadActivities() {
    try {
      // ‚úÖ –Ø–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º auth session –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
      await supabase.auth.getSession()
      
      // ‚úÖ –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ
      await new Promise(resolve => setTimeout(resolve, 50))
      
      if (cancelled) return
      
      // ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –∫–∞—Ç–∞–ª–æ–≥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
      const { data, error: queryError } = await supabase
        .from('activity_catalog')
        .select('id, name_ru, name_en, category, icon, description')
        .order('name_ru', { ascending: true })
      
      if (cancelled) return
      
      if (queryError) {
        throw queryError
      }
      
      setActivities(data || [])
      setIsLoading(false)
    } catch (err) {
      if (!cancelled) {
        setError(err instanceof Error ? err : new Error('Unknown error'))
        setIsLoading(false)
      }
    }
  }
  
  // ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const timer = setTimeout(() => {
    loadActivities()
  }, 100)
  
  return () => {
    cancelled = true
    clearTimeout(timer)
  }
}, [supabase])
```

---

## üéØ **–ü–û–ß–ï–ú–£ –≠–¢–û –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£**

### **1. –ú–µ–º–æ–∏–∑–∞—Ü–∏—è client (`useMemo`)**
- Client —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ client –≤ –∫–∞–∂–¥–æ–º render

### **2. –Ø–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è auth session**
- `await supabase.auth.getSession()` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ auth –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
- Supabase client –±–æ–ª—å—à–µ –Ω–µ –∂–¥—ë—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ session –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
- –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ session –≥–æ—Ç–æ–≤

### **3. –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (100ms)**
- –î–∞—ë—Ç –≤—Ä–µ–º—è –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏ –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –≤ wizard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –≥–¥–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
- –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (50ms –ø–æ—Å–ª–µ session + 100ms –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º) –Ω–µ –∑–∞–º–µ—Ç–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢**

- ‚úÖ –ü—Ä—è–º–æ–π Supabase –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ wizard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- ‚úÖ HTTP-–∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–∞ ~200-400ms
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π –∏–ª–∏ timeout'–æ–≤
- ‚úÖ –ï–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤–æ –≤—Å—ë–º –ø—Ä–æ–µ–∫—Ç–µ (–ø—Ä—è–º–æ–π Supabase –∑–∞–ø—Ä–æ—Å)

---

## üìã **–í–ê–ñ–ù–û**

**–î–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
- –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø–æ—Ö–æ–∂–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≤–∏—Å–∞–Ω–∏–µ–º Supabase –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥:
  1. –ú–µ–º–æ–∏–∑–∏—Ä—É–π—Ç–µ client —á–µ—Ä–µ–∑ `useMemo`
  2. –Ø–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ auth session –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
  3. –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (50-100ms)

**–ù–µ –Ω—É–∂–Ω–æ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint –∫–∞–∫ workaround (–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ –Ω—É–∂–µ–Ω server-side –∫—ç—à)
- –¢—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –æ—Ç–ª–∞–¥–∫—É –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã

---

## üîÑ **–£–î–ê–õ–Å–ù–ù–´–ï –§–ê–ô–õ–´**

- `app/api/activity-catalog/route.ts` - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–¥–µ-—Ç–æ –µ—â—ë)
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ –∏–∑ `lib/supabase/client.ts` - —É–±—Ä–∞–Ω—ã

---

## üìù **–°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´**

- `docs/SUPABASE_CLIENT_ISSUE.md` - –∏—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- `docs/SUPABASE_CLIENT_VS_API_ENDPOINT.md` - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤
- `docs/WHY_SUPABASE_CLIENT_FAILS_IN_WIZARD.md` - –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–±–ª–µ–º—ã




