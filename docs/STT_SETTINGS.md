# üéôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (STT)

## üìã –û–±–∑–æ—Ä

–¢–µ–ø–µ—Ä—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:

1. **Whisper (–ª–æ–∫–∞–ª—å–Ω—ã–π)** - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
2. **Gemini 2.0 Flash** - –û–±–ª–∞—á–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π –∏ —Ç–æ—á–Ω—ã–π

---

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### Whisper (–ª–æ–∫–∞–ª—å–Ω—ã–π)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ** - –Ω–∏–∫–∞–∫–∏—Ö –∑–∞—Ç—Ä–∞—Ç
- ‚úÖ **–ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω
- ‚úÖ **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å** - –¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Ö–æ–¥—è—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ **–ë–µ–∑ API –∫–ª—é—á–µ–π** - –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ú–µ–¥–ª–µ–Ω–Ω–µ–µ** - 10-15 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
- ‚ùå **–ù–∏–∂–µ —Ç–æ—á–Ω–æ—Å—Ç—å** - 85-90%
- ‚ùå **–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏** - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–µ–¥–ª–µ–Ω–Ω—ã–π (75 MB)
- ‚ùå **–¢—Ä–µ–±—É–µ—Ç ffmpeg** - –Ω—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### Gemini 2.0 Flash

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ë—ã—Å—Ç—Ä–æ** - 2-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
- ‚úÖ **–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** - 95-98%
- ‚úÖ **–ë–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
- ‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç ffmpeg** - –ø—Ä–æ—Å—Ç–æ API –≤—ã–∑–æ–≤

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ü–ª–∞—Ç–Ω–æ** - ~$0.00001 –∑–∞ —Å–µ–∫—É–Ω–¥—É –∞—É–¥–∏–æ
- ‚ùå **–¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç** - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω
- ‚ùå **API –∫–ª—é—á** - –Ω—É–∂–µ–Ω Gemini API key
- ‚ùå **–î–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Google

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –û—Ç–∫—Ä–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

–ü–µ—Ä–µ–π–¥–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ AI:
```
http://localhost:4000/admin/ai-settings
```

–ü—Ä–æ–∫—Ä—É—Ç–∏ –≤–Ω–∏–∑ –¥–æ —Å–µ–∫—Ü–∏–∏ **"–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (STT)"**.

### 2. –í—ã–±–µ—Ä–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä

–£–≤–∏–¥–∏—à—å 2 –∫–∞—Ä—Ç–æ—á–∫–∏:
- **Whisper (–ª–æ–∫–∞–ª—å–Ω—ã–π)** - –∞–∫—Ç–∏–≤–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **Gemini 2.0 Flash** - –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω

### 3. –ü–µ—Ä–µ–∫–ª—é—á–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä

–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É **"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"** –Ω–∞ –Ω—É–∂–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ.

‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

---

## üíª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
User speaks into microphone
      ‚Üì
MediaRecorder API (WebM format)
      ‚Üì
POST /api/ai/transcribe
      ‚Üì
Load active STT setting from DB
      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ If Whisper     ‚îÇ If Gemini      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ WebM ‚Üí WAV     ‚îÇ WebM ‚Üí base64  ‚îÇ
‚îÇ via ffmpeg     ‚îÇ                ‚îÇ
‚îÇ       ‚Üì        ‚îÇ       ‚Üì        ‚îÇ
‚îÇ WAV ‚Üí PCM      ‚îÇ Send to Gemini ‚îÇ
‚îÇ (Float32Array) ‚îÇ API            ‚îÇ
‚îÇ       ‚Üì        ‚îÇ       ‚Üì        ‚îÇ
‚îÇ transformers.js‚îÇ Get response   ‚îÇ
‚îÇ Whisper model  ‚îÇ                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚Üì
Return transcribed text
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü–∞: `stt_settings`**

```sql
CREATE TABLE stt_settings (
  id UUID PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  provider TEXT NOT NULL, -- 'whisper' | 'gemini'
  is_active BOOLEAN DEFAULT false,
  settings JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
)
```

**–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**

```json
[
  {
    "name": "Whisper (–ª–æ–∫–∞–ª—å–Ω—ã–π)",
    "provider": "whisper",
    "is_active": true,
    "settings": {
      "model": "Xenova/whisper-small",
      "language": "ru"
    }
  },
  {
    "name": "Gemini 2.0 Flash",
    "provider": "gemini",
    "is_active": false,
    "settings": {
      "model": "gemini-2.0-flash-exp",
      "mimeType": "audio/webm"
    }
  }
]
```

### API Endpoints

#### GET /api/admin/stt-settings

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ STT.

**Response:**
```json
{
  "settings": [
    {
      "id": "uuid",
      "name": "Whisper (–ª–æ–∫–∞–ª—å–Ω—ã–π)",
      "provider": "whisper",
      "is_active": true,
      "settings": {...}
    },
    ...
  ]
}
```

#### PATCH /api/admin/stt-settings

–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

**Request:**
```json
{
  "id": "uuid"
}
```

**Response:**
```json
{
  "setting": {
    "id": "uuid",
    "name": "Gemini 2.0 Flash",
    "is_active": true,
    ...
  }
}
```

#### POST /api/ai/transcribe

–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ.

**Request:**
```
multipart/form-data:
  audio: File (WebM)
```

**Response:**
```json
{
  "text": "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ KidsPoint",
  "language": "ru",
  "provider": "whisper", // or "gemini"
  "duration": 3.5 // —Ç–æ–ª—å–∫–æ –¥–ª—è whisper
}
```

### –ö–æ–¥

**Whisper —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:**

```typescript
async function transcribeWithWhisper(audioFile: File, settings: any) {
  // 1. Load transformers.js
  const { pipeline } = await import('@xenova/transformers')
  const transcriber = await pipeline(
    'automatic-speech-recognition',
    settings.model || 'Xenova/whisper-small'
  )

  // 2. Convert WebM ‚Üí WAV via ffmpeg
  const wavBuffer = await convertToWav(audioFile)

  // 3. Decode WAV ‚Üí Float32Array (PCM)
  const audioFloat32 = await decodeWav(wavBuffer)

  // 4. Transcribe
  const result = await transcriber(audioFloat32, {
    language: settings.language || 'ru',
    task: 'transcribe',
  })

  return { text: result.text.trim(), provider: 'whisper' }
}
```

**Gemini —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:**

```typescript
async function transcribeWithGemini(audioFile: File, settings: any) {
  // 1. Read audio as base64
  const arrayBuffer = await audioFile.arrayBuffer()
  const base64Audio = Buffer.from(arrayBuffer).toString('base64')

  // 2. Call Gemini API
  const { GoogleGenerativeAI } = await import('@google/generative-ai')
  const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)
  const model = genAI.getGenerativeModel({ 
    model: settings.model || 'gemini-2.0-flash-exp'
  })

  const result = await model.generateContent([
    {
      inlineData: {
        data: base64Audio,
        mimeType: settings.mimeType || 'audio/webm'
      }
    },
    {
      text: '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–π –∞—É–¥–∏–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç.'
    }
  ])

  return { text: result.response.text().trim(), provider: 'gemini' }
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

```bash
curl http://localhost:4000/api/admin/stt-settings \
  -H "Authorization: Bearer YOUR_TOKEN"
```

–ù–∞–π–¥–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å `is_active: true`.

### 2. –ü–µ—Ä–µ–∫–ª—é—á–∏ –Ω–∞ Gemini

```bash
curl -X PATCH http://localhost:4000/api/admin/stt-settings \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"id": "GEMINI_UUID"}'
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é

–í AI-—á–∞—Ç–µ:
1. –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
2. –°–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?")
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:**
- **Whisper**: 10-15 —Å–µ–∫—É–Ω–¥
- **Gemini**: 2-3 —Å–µ–∫—É–Ω–¥—ã

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

**Whisper:**
```
[Whisper STT] Starting transcription...
[Whisper STT] Loading transformers...
[Whisper STT] Model loaded successfully!
[Whisper STT] Converting to WAV via ffmpeg...
[Whisper STT] Transcription successful: "—Ç–µ–∫—Å—Ç"
```

**Gemini:**
```
[Gemini STT] Starting transcription...
[Gemini STT] Transcription successful: "—Ç–µ–∫—Å—Ç"
```

### –°—Ç–æ–∏–º–æ—Å—Ç—å (Gemini)

**–†–∞—Å—á–µ—Ç:**
```
–¶–µ–Ω–∞: ~$0.00001 –∑–∞ —Å–µ–∫—É–Ω–¥—É –∞—É–¥–∏–æ
–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 5 —Å–µ–∫—É–Ω–¥
–°—Ç–æ–∏–º–æ—Å—Ç—å: $0.00005 –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
100 —Å–æ–æ–±—â–µ–Ω–∏–π = $0.005
1000 —Å–æ–æ–±—â–µ–Ω–∏–π = $0.05
```

**–ò—Ç–æ–≥–æ:** –û—á–µ–Ω—å –¥–µ—à–µ–≤–æ! üí∞

---

## ‚ùì FAQ

### Q: –ö–∞–∫–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤—ã–±—Ä–∞—Ç—å?

**A:**
- **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: Whisper (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- **–î–ª—è production**: Gemini (–±—ã—Å—Ç—Ä–µ–µ –∏ —Ç–æ—á–Ω–µ–µ)

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞?

**A:** –ù–µ—Ç, –∞–∫—Ç–∏–≤–Ω—ã–º –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω. –ù–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç 1 –∫–ª–∏–∫.

### Q: –ß—Ç–æ –µ—Å–ª–∏ —É –º–µ–Ω—è –Ω–µ—Ç Gemini API –∫–ª—é—á–∞?

**A:** –ò—Å–ø–æ–ª—å–∑—É–π Whisper! –û–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π.

### Q: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä?

**A:**
1. –î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –≤ `stt_settings`
2. –û–±–Ω–æ–≤–∏ `/api/ai/transcribe` —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π
3. –ì–æ—Ç–æ–≤–æ!

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?

**A:** –î–∞! –û–±–Ω–æ–≤–∏ –ø–æ–ª–µ `settings` –≤ —Ç–∞–±–ª–∏—Ü–µ `stt_settings`. –ù–∞–ø—Ä–∏–º–µ—Ä:

```sql
UPDATE stt_settings
SET settings = '{"model": "Xenova/whisper-base", "language": "en"}'::jsonb
WHERE provider = 'whisper';
```

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—à—å –æ—Ç –æ–¥–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
- ‚úÖ –ú–æ–∂–µ—à—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ß—Ç–æ –¥–∞–ª—å—à–µ:**
- üîú –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (OpenAI Whisper API, Azure, –∏ —Ç.–¥.)
- üîú –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
- üîú A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏
- üîú –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

