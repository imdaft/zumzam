# üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ AI —á–∞—Ç–∞ –∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (Yandex Cloud PostgreSQL) –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å:
1. **AI —á–∞—Ç** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∑–∞–≥–ª—É—à–∫—É –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ AI
2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** - –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –ø—Ä–æ–º–ø—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
3. **Embeddings** - –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ embedding –≤ –±–∞–∑–µ (0 –∏–∑ 48 –ø—Ä–æ—Ñ–∏–ª–µ–π)
4. **pgvector** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Yandex Cloud

## ‚úÖ –ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

### 1. AI —á–∞—Ç —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ (`app/api/ai/chat/route.ts`)

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:**
- ‚úÖ –ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
- ‚úÖ –¢–µ–ø–ª—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç "–≤–∑–ª–æ–º–∞" –∏ off-topic –≤–æ–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (3 —à—Ç—É–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gemini 2.0 Flash
- ‚úÖ Rate limiting (20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Å)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫** –≤–º–µ—Å—Ç–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ (–¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pgvector)
- –ü–æ–∏—Å–∫ –ø–æ: `display_name`, `bio`, `description`, `city`

### 2. –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:**
- `supabase/migrations/20250129_add_vector_search_function.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `scripts/apply-vector-search.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è psql
- `scripts/apply-vector-search.ts` - Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

**–§—É–Ω–∫—Ü–∏—è `search_profiles_by_vector`:**
```sql
CREATE OR REPLACE FUNCTION search_profiles_by_vector(
  query_embedding vector(768),
  match_threshold float DEFAULT 0.3,
  match_count int DEFAULT 8,
  filter_category text DEFAULT NULL,
  filter_city text DEFAULT NULL
)
```

**–ò–Ω–¥–µ–∫—Å:**
```sql
CREATE INDEX idx_profiles_embedding_vector 
ON profiles 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100)
```

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pgvector –Ω–∞ Yandex Cloud

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `vector` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ PostgreSQL

**–†–µ—à–µ–Ω–∏–µ:**
1. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Yandex Cloud
2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `pgvector` –¥–ª—è PostgreSQL 16
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Managed PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π pgvector

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Supabase (pgvector —É–∂–µ –≤–∫–ª—é—á–µ–Ω)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç–∏–Ω–≥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π pgvector

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pgvector:

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ psql
psql "postgresql://zumzam_admin:SCNK88tank33@rc1b-ktk7vobktajbv2sd.mdb.yandexcloud.net:6432/zumzam?sslmode=require" -f scripts/apply-vector-search.sql

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Node.js —Å–∫—Ä–∏–ø—Ç
npx tsx scripts/apply-vector-search.ts
```

### –®–∞–≥ 3: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å embeddings –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ embeddings
npx tsx scripts/update-embeddings.ts
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –≤–µ–∫—Ç–æ—Ä—ã (768 —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å) –¥–ª—è –≤—Å–µ—Ö 48 –ø—Ä–æ—Ñ–∏–ª–µ–π.

### –®–∞–≥ 4: –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å AI —á–∞—Ç –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

–í —Ñ–∞–π–ª–µ `app/api/ai/chat/route.ts` –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π:

```typescript
// –ë–´–õ–û (—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫):
const profiles = await prisma.profiles.findMany({
  where: {
    is_published: true,
    OR: [
      { display_name: { contains: message, mode: 'insensitive' } },
      // ...
    ]
  }
})

// –°–¢–ê–ù–ï–¢ (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫):
const queryEmbedding = await generateEmbedding(message)
const embeddingString = `[${queryEmbedding.join(',')}]`

const profiles = await prisma.$queryRawUnsafe(`
  SELECT * FROM search_profiles_by_vector(
    $1::vector,
    0.3,  -- threshold
    8     -- limit
  )
`, embeddingString)
```

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-----------|--------|------------|
| AI —á–∞—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –° —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–∏—Å–∫–æ–º |
| –ü—Ä–æ–º–ø—Ç—ã | ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã | –ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç |
| –ó–∞—â–∏—Ç–∞ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | Rate limiting, –∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∑–ª–æ–º–∞ |
| –ü–æ–¥—Å–∫–∞–∑–∫–∏ | ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç | 3 –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ |
| –û—Ç–∑—ã–≤—ã | ‚úÖ –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è | –î–ª—è —Ç–æ–ø-3 –ø—Ä–æ—Ñ–∏–ª–µ–π |
| pgvector | ‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ | –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |
| Embeddings | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç | 0 –∏–∑ 48 –ø—Ä–æ—Ñ–∏–ª–µ–π |
| –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pgvector |

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (—Å–µ–π—á–∞—Å):
- ‚úÖ AI —á–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–∏—Å–∫–æ–º
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
- ‚ö†Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞ –Ω–∏–∂–µ, —á–µ–º —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (1-2 –Ω–µ–¥–µ–ª–∏):
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pgvector –Ω–∞ Yandex Cloud
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å embeddings –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
4. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Supabase (pgvector –∏–∑ –∫–æ—Ä–æ–±–∫–∏)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é embeddings –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
- –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ AI –æ—Ç–≤–µ—Ç–æ–≤

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `app/api/ai/chat/route.ts` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–∞–±–æ—á–∏–π AI —á–∞—Ç
2. `supabase/migrations/20250129_add_vector_search_function.sql` - –º–∏–≥—Ä–∞—Ü–∏—è
3. `scripts/apply-vector-search.sql` - SQL —Å–∫—Ä–∏–ø—Ç
4. `scripts/apply-vector-search.ts` - Node.js —Å–∫—Ä–∏–ø—Ç
5. `scripts/check-embeddings.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ embeddings
6. `docs/AI_CHAT_RESTORATION.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/AI_VECTOR_SEARCH.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∏—Å–∫—É
- `docs/AI_IMPLEMENTATION_COMPLETE.md` - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è AI
- `docs/AI_PROTECTION_AND_FEATURES.md` - –∑–∞—â–∏—Ç–∞ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
- `lib/ai/embeddings.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings
- `lib/ai/gemini.ts` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gemini API

