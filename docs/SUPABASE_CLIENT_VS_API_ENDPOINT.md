# üîç Client-Side Supabase vs API Endpoint: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

> UPDATE: –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –ø—Ä—è–º—ã–µ client-side –∑–∞–ø—Ä–æ—Å—ã –≤ wizard **—Ä–∞–±–æ—Ç–∞—é—Ç** –±–ª–∞–≥–æ–¥–∞—Ä—è
> `lib/supabase/client.ts` (singleton) + —Ç–∞–π–º–∞—É—Ç–∞–º –≤ —à–∞–≥–∞—Ö. –í—Ä–µ–º–µ–Ω–Ω—ã–µ API‚Äë—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
> `app/api/activity-catalog/*` —É–¥–∞–ª–µ–Ω—ã.

## üìä –î–í–ê –ü–û–î–•–û–î–ê

### 1Ô∏è‚É£ **–ü—Ä—è–º–æ–π Client-Side Supabase –∑–∞–ø—Ä–æ—Å**
```tsx
// ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ wizard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
const supabase = createClient()
const { data } = await supabase
  .from('activity_catalog')
  .select('id, name_ru, name_en, category, icon, description')
  .order('name_ru', { ascending: true })
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Supabase JS client —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–º–∏—Å
- –ü—Ä–æ–º–∏—Å –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å –∫ `*.supabase.co/rest/v1/activity_catalog`
- –û—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ –∏ resolve –ø—Ä–æ–º–∏—Å

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ wizard:**
- –ü—Ä–æ–º–∏—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚úÖ
- HTTP-–∑–∞–ø—Ä–æ—Å **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** ‚ùå (–Ω–µ—Ç –≤ Network tab)
- –ü—Ä–æ–º–∏—Å –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ (timeout 5+ —Å–µ–∫—É–Ω–¥)

**–ì–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ `activity-filters.tsx` - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚úÖ –î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

### 2Ô∏è‚É£ **API Endpoint (Server-Side Supabase)**
```tsx
// ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤–µ–∑–¥–µ
const response = await fetch('/api/activity-catalog')
const json = await response.json()
const data = json.data
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. Browser ‚Üí `fetch('/api/activity-catalog')`
2. Next.js Server ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç route handler
3. Server ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `createClient()` (server-side)
4. Server ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Supabase
5. Server ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –æ—Ç–≤–µ—Ç
6. Browser ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å client-side –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)
- ‚úÖ –ë—ã—Å—Ç—Ä–æ (~400-500ms)
- ‚úÖ –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ Next.js
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å rate limiting, –≤–∞–ª–∏–¥–∞—Ü–∏—é, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ (–Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –∫–ª–∏–µ–Ω—Ç—É –Ω–∞–ø—Ä—è–º—É—é)

---

## ü§î –ü–û–ß–ï–ú–£ –ü–†–Ø–ú–û–ô –ó–ê–ü–†–û–° –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –í WIZARD?

**üìñ –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** –°–º. [`docs/WHY_SUPABASE_CLIENT_FAILS_IN_WIZARD.md`](./WHY_SUPABASE_CLIENT_FAILS_IN_WIZARD.md)

**–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

### **–ö–ª—é—á–µ–≤–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ:**

1. **`activity-filters.tsx` (—Ä–∞–±–æ—Ç–∞–µ—Ç):**
   - –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
   - –ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - Auth session —É–∂–µ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
   - –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

2. **`step-2-activities.tsx` –≤ wizard (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):**
   - –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã (`CreateProfileForm`)
   - React Hook Form + –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ useEffect'–æ–≤ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (—É—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
   - Auth session –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### **–ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: Auth Session –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**

Supabase client –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ auth session –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞:

- –í `activity-filters.tsx`: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚Üí auth session –≥–æ—Ç–æ–≤–∞ ‚Üí –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚úÖ
- –í wizard: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ ‚Üí auth session –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤–∞ ‚Üí client –∂–¥—ë—Ç ‚Üí timeout ‚ùå

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:**
- –ü—Ä–æ–º–∏—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚úÖ (query builder —Å–æ–∑–¥–∞–Ω)
- HTTP-–∑–∞–ø—Ä–æ—Å **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** ‚ùå (–Ω–µ—Ç –≤ Network tab)
- –ü—Ä–æ–º–∏—Å –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞

**–î—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- React Hook Form –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π
- Navigator Lock (`lockNoOp`) –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ wizard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø –î–õ–Ø PRODUCTION

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API Endpoint –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ wizard**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Next.js cache, Redis)
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å rate limiting, –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ** - –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ª–µ–≥—á–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è API Endpoint:**

```tsx
// app/api/activity-catalog/route.ts
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export const revalidate = 3600 // –ö—ç—à –Ω–∞ 1 —á–∞—Å (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

export async function GET() {
  try {
    const supabase = await createClient()
    
    const { data, error } = await supabase
      .from('activity_catalog')
      .select('id, name_ru, name_en, category, icon, description')
      .order('name_ru', { ascending: true })
    
    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 })
    }
    
    // Next.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è revalidate
    return NextResponse.json({ data: data || [] })
  } catch (err) {
    return NextResponse.json(
      { error: err instanceof Error ? err.message : 'Unknown error' },
      { status: 500 }
    )
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: ~400-500ms
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã: ~10-50ms (–∏–∑ –∫—ç—à–∞ Next.js)
- –ö–∞—Ç–∞–ª–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ ‚Üí –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–æ

---

## üîÑ –ú–ò–ì–†–ê–¶–ò–Ø

### **–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å `activity-filters.tsx`?**

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å** (—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
- –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å
- –ú–µ–Ω—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π = –º–µ–Ω—å—à–µ —Ä–∏—Å–∫–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç 2: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint)
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤–æ –≤—Å—ë–º –ø—Ä–æ–µ–∫—Ç–µ
- –ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å `activity-filters.tsx` –∫–∞–∫ –µ—Å—Ç—å (–≤–∞—Ä–∏–∞–Ω—Ç 1), –Ω–æ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint.

---

## üìù –ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–î–ª—è Production:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint –¥–ª—è wizard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (`revalidate`)
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ `activity-filters.tsx` (—Ä–∞–±–æ—Ç–∞–µ—Ç)

**–ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ wizard:**
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–º–∏—Å –∑–∞–≤–∏—Å–∞–µ—Ç, HTTP-–∑–∞–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è)
- ‚ùå –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ (–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

**–ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API endpoint:**
- ‚úÖ –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å (–±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å




