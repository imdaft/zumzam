# Парсинг отзывов с Яндекс.Карт

## ✅ РЕШЕНИЕ РАБОТАЕТ (100% отзывов)

### Локальная разработка (Windows)

1. **Парсинг работает автоматически:**
   - Откроется видимое окно браузера Chrome
   - Автоматически найдёт и нажмёт кнопку "Посмотреть все N отзывов"
   - Прокрутит список для подгрузки всех отзывов
   - Спарсит все данные (140/140 отзывов)
   - Закроется автоматически

2. **Как использовать:**
   - Перейдите в настройки профиля
   - Добавьте URL с Яндекс.Карт (например: `https://yandex.ru/maps/org/kids_point/140508158689/`)
   - Нажмите "Загрузить отзывы с Яндекс.Карт"
   - Дождитесь завершения (откроется и закроется окно браузера)
   - Отзывы появятся на странице профиля

### Продакшн (Linux сервер)

#### Вариант 1: Виртуальный дисплей (Xvfb)

```bash
# 1. Установка зависимостей
sudo apt-get install -y xvfb libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2

# 2. Запуск виртуального дисплея
sudo systemctl enable xvfb
sudo systemctl start xvfb

# 3. Настройка переменной окружения
export DISPLAY=:99

# 4. Парсер будет работать в "невидимом" браузере на виртуальном дисплее
```

#### Вариант 2: Автоматический парсинг по расписанию

```bash
# Запуск каждые 6 часов (настроено в systemd timer)
sudo systemctl enable yandex-reviews-parser.timer
sudo systemctl start yandex-reviews-parser.timer

# Просмотр логов
sudo journalctl -u yandex-reviews-parser.service -f
```

#### Вариант 3: Headless режим с mock-данными

Если Xvfb не работает:
- Парсер вернётся в `headless: true` режим
- При встрече с CAPTCHA вернёт 10 mock-отзывов для демонстрации
- Подходит для разработки и демо

## Технические детали

### Почему работает:

1. ✅ **Видимый браузер (`headless: false`)** - Яндекс не показывает CAPTCHA
2. ✅ **Stealth плагин** - Скрывает признаки автоматизации
3. ✅ **Persistent session** - Сохраняет cookies между запусками
4. ✅ **Клик по кнопке** - Загружает ВСЕ отзывы, а не только первые 50-60
5. ✅ **Умная прокрутка** - Останавливается, когда отзывы больше не подгружаются
6. ✅ **Дедупликация** - Убирает дубликаты по тексту отзыва

### Структура файлов:

- `lib/puppeteer-parser.ts` - Основной парсер
- `scripts/auto-parse-reviews.ts` - Автоматический парсинг для всех локаций
- `docs/setup-linux-xvfb.sh` - Настройка виртуального дисплея на Linux
- `docs/setup-auto-parser.sh` - Настройка systemd timer для автозапуска

### Кеширование:

- Таблица: `yandex_reviews_cache`
- TTL: 1 час (можно настроить)
- RLS политики: только владелец может обновлять кеш своих локаций

## Тестовые скрипты (для отладки):

- `test-final-click.js` - Работающий тест (140/140 отзывов)
- `test-real-browser.js` - Тест видимого браузера
- `test-find-exact-button.js` - Поиск кнопки "Посмотреть все отзывы"


